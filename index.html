<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Maria's Word Vault</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;1,400;1,600&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #1a1208;
  --ink-soft: #3d3224;
  --ink-faint: #6b5d4f;
  --paper: #faf7f2;
  --paper-warm: #f5f0e8;
  --paper-dim: #ebe5d9;
  --gold: #c9943a;
  --gold-light: #e8c97a;
  --gold-dim: #8a6420;
  --rust: #b84c2a;
  --sage: #4a7c5e;
  --sage-light: #d4e8dc;
  --blue-select: #a8c8e8;
  --blue-active: #6ba3d6;
  --cell-size: 40px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%; width: 100%;
  overflow: hidden;
  font-family: 'DM Sans', sans-serif;
  background: var(--paper);
  color: var(--ink);
  -webkit-tap-highlight-color: transparent;
  -webkit-text-size-adjust: 100%;
}
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}
.font-display { font-family: 'Playfair Display', Georgia, serif; }
.font-mono { font-family: 'DM Mono', monospace; }

/* ‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê */
.screen {
  display: none;
  position: fixed; inset: 0;
  flex-direction: column;
  align-items: center;
  overflow-y: auto;
  background: var(--paper);
}
.screen.active { display: flex; }

/* ‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê */
#screenLobby { justify-content: center; padding: 24px; gap: 0; }
.lobby-masthead { text-align: center; margin-bottom: 32px; }
.lobby-rule { width: 60px; height: 2px; background: var(--gold); margin: 0 auto 12px; }
.lobby-title { font-family: 'Playfair Display', serif; font-size: clamp(1.6rem, 6vw, 2.4rem); font-weight: 800; color: var(--ink); line-height: 1.1; }
.lobby-subtitle { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--ink-faint); letter-spacing: 3px; text-transform: uppercase; margin-top: 6px; }
.lobby-card { width: 100%; max-width: 380px; }
.lobby-section { margin-bottom: 16px; }
.lobby-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--ink-faint); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
.lobby-input {
  font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 600;
  padding: 10px 14px; border: 2px solid var(--paper-dim); border-radius: 2px;
  background: white; color: var(--ink); width: 100%; outline: none;
  box-shadow: 2px 2px 0 var(--paper-dim); transition: border-color 0.2s;
}
.lobby-input:focus { border-color: var(--gold); }
.mode-row, .puzzle-row { display: flex; gap: 6px; }
.mode-btn, .puzzle-btn {
  flex: 1; font-family: 'DM Sans', sans-serif; font-size: 0.75rem; font-weight: 600;
  padding: 8px 4px; border: 2px solid var(--paper-dim); border-radius: 2px;
  background: white; color: var(--ink-faint); cursor: pointer; text-align: center;
  transition: all 0.15s;
}
.mode-btn.selected, .puzzle-btn.selected {
  border-color: var(--gold); color: var(--ink); background: var(--gold-light);
  box-shadow: 2px 2px 0 var(--gold-dim);
}
.btn-primary {
  font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700;
  width: 100%; padding: 12px; border: none; border-radius: 2px;
  color: white; cursor: pointer; margin-top: 8px; transition: all 0.12s;
}
.btn-gold { background: var(--gold); box-shadow: 0 3px 0 var(--gold-dim); }
.btn-gold:active { transform: translateY(3px); box-shadow: none; }
.btn-sage { background: var(--sage); box-shadow: 0 3px 0 #375e46; }
.btn-sage:active { transform: translateY(3px); box-shadow: none; }
.btn-outline-sm {
  font-family: 'DM Mono', monospace; font-size: 0.7rem; font-weight: 500;
  padding: 6px 12px; border: 2px solid var(--paper-dim); border-radius: 2px;
  background: transparent; color: var(--ink-faint); cursor: pointer;
}
.btn-outline-sm:hover { border-color: var(--gold); color: var(--ink); }
#roomArea { display: none; }
.lobby-select {
  font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
  padding: 8px 12px; border: 2px solid var(--paper-dim); border-radius: 2px;
  background: white; color: var(--ink); width: 100%; outline: none;
}
.lobby-links { text-align: center; margin-top: 16px; display: flex; gap: 12px; justify-content: center; }
.lobby-links a, .lobby-links button {
  font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--ink-faint);
  text-decoration: none; background: none; border: none; cursor: pointer;
}
.lobby-links a:hover, .lobby-links button:hover { color: var(--gold); }

/* ‚ïê‚ïê‚ïê INSTRUCTIONS ‚ïê‚ïê‚ïê */
#screenInstructions { padding: 24px; justify-content: flex-start; }
.instr-container { max-width: 420px; width: 100%; }
.instr-back { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--ink-faint); cursor: pointer; background: none; border: none; margin-bottom: 20px; }
.instr-back:hover { color: var(--gold); }
.instr-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 800; margin-bottom: 4px; }
.instr-rule { width: 40px; height: 2px; background: var(--gold); margin-bottom: 20px; }
.instr-section { margin-bottom: 20px; }
.instr-heading { font-family: 'DM Mono', monospace; font-size: 0.6rem; letter-spacing: 2px; text-transform: uppercase; color: var(--gold-dim); margin-bottom: 8px; }
.instr-text { font-size: 0.85rem; line-height: 1.6; color: var(--ink-soft); }
.instr-text strong { color: var(--ink); font-weight: 600; }

/* ‚ïê‚ïê‚ïê WAITING ‚ïê‚ïê‚ïê */
#screenWaiting { justify-content: center; padding: 24px; }
.waiting-card { text-align: center; max-width: 380px; }
.waiting-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; }
.waiting-code { font-family: 'DM Mono', monospace; font-size: 2rem; font-weight: 500; color: var(--gold); letter-spacing: 6px; margin: 12px 0; }
.waiting-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--ink-faint); letter-spacing: 2px; text-transform: uppercase; }
.share-url { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--sage); word-break: break-all; cursor: pointer; margin: 8px 0 16px; }
.player-slots { display: flex; gap: 12px; justify-content: center; margin: 20px 0; }
.player-slot {
  padding: 10px 16px; border: 2px solid var(--paper-dim); border-radius: 2px;
  font-family: 'DM Sans', sans-serif; font-size: 0.8rem; color: var(--ink-faint);
  min-width: 120px; text-align: center;
}
.player-slot.connected { border-color: var(--sage); color: var(--sage); background: var(--sage-light); }

/* ‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê */
#screenGame { flex-direction: column; align-items: stretch; overflow: hidden; }
.game-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 6px 12px; border-bottom: 1px solid var(--paper-dim);
  min-height: 36px; flex-shrink: 0;
}
.hud-title { font-family: 'Playfair Display', serif; font-size: 0.85rem; font-weight: 700; }
.hud-right { display: flex; gap: 12px; align-items: center; }
.hud-timer { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--ink-faint); }
.hud-score { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--gold-dim); }
.hud-back { font-size: 1rem; background: none; border: none; cursor: pointer; color: var(--ink-faint); padding: 4px; }
.clue-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 12px; background: var(--paper-warm);
  border-bottom: 1px solid var(--paper-dim);
  min-height: 36px; flex-shrink: 0; cursor: pointer;
}
.clue-bar-num { font-family: 'DM Mono', monospace; font-size: 0.7rem; font-weight: 500; color: var(--gold-dim); white-space: nowrap; }
.clue-bar-text { font-size: 0.8rem; color: var(--ink-soft); flex: 1; }
.grid-wrapper {
  flex: 1; display: flex; align-items: center; justify-content: center;
  padding: 8px; overflow: hidden; min-height: 0;
}
.crossword-grid {
  display: inline-grid; gap: 0;
  border: 2px solid var(--ink);
  box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
}
.grid-cell {
  width: var(--cell-size); height: var(--cell-size);
  border: 0.5px solid #bbb;
  display: flex; align-items: center; justify-content: center;
  position: relative; cursor: pointer;
  background: white; user-select: none;
  transition: background 0.1s;
}
.grid-cell.black { background: var(--ink); cursor: default; }
.grid-cell.selected { background: var(--blue-active) !important; }
.grid-cell.word-highlight { background: var(--blue-select); }
.grid-cell.peer-cursor { box-shadow: inset 0 0 0 2px var(--rust); }
.cell-number {
  position: absolute; top: 1px; left: 2px;
  font-family: 'DM Sans', sans-serif; font-size: calc(var(--cell-size) * 0.22);
  font-weight: 700; color: var(--ink-faint); line-height: 1;
}
.cell-letter {
  font-family: 'DM Sans', sans-serif;
  font-size: calc(var(--cell-size) * 0.48);
  font-weight: 700; color: var(--ink); text-transform: uppercase;
}

/* On-screen keyboard */
.osk {
  flex-shrink: 0; padding: 4px 4px 8px;
  background: var(--paper-dim); border-top: 1px solid #ccc;
}
.osk-row { display: flex; justify-content: center; gap: 3px; margin-bottom: 3px; }
.osk-key {
  font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 700;
  min-width: 26px; height: 38px; border: none; border-radius: 4px;
  background: white; color: var(--ink); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
  transition: background 0.08s;
  flex: 1; max-width: 38px;
}
.osk-key:active { background: var(--blue-select); transform: translateY(1px); box-shadow: none; }
.osk-key.wide { min-width: 44px; max-width: 56px; font-size: 0.7rem; letter-spacing: 0.5px; }
.osk-key.accent { background: var(--gold-light); color: var(--gold-dim); }

/* Direction + clue toggle bar */
.dir-bar {
  display: flex; gap: 0; flex-shrink: 0;
  border-top: 1px solid var(--paper-dim);
  border-bottom: 1px solid var(--paper-dim);
}
.dir-btn {
  flex: 1; font-family: 'DM Mono', monospace; font-size: 0.65rem;
  font-weight: 500; letter-spacing: 1px; text-transform: uppercase;
  padding: 6px; border: none; background: var(--paper-warm);
  color: var(--ink-faint); cursor: pointer; text-align: center;
}
.dir-btn.active { background: var(--gold-light); color: var(--gold-dim); font-weight: 700; }
.dir-btn-clue {
  padding: 6px 14px; border: none; background: var(--paper-warm);
  color: var(--ink-faint); cursor: pointer; font-size: 1.1rem;
  border-left: 1px solid var(--paper-dim);
  font-weight: 700;
}

/* Clue drawer */
.clue-drawer {
  background: var(--paper-warm); border-top: 1px solid var(--paper-dim);
  max-height: 180px; overflow-y: auto; padding: 8px 12px;
  -webkit-overflow-scrolling: touch;
  flex-shrink: 0;
}
.clue-drawer.open { }
.clue-drawer-handle { display: none; }
.clue-section { margin-bottom: 12px; }
.clue-section-title { font-family: 'DM Mono', monospace; font-size: 0.6rem; letter-spacing: 2px; text-transform: uppercase; color: var(--gold-dim); margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid var(--paper-dim); }
.clue-item { display: flex; gap: 6px; padding: 4px 0; cursor: pointer; align-items: baseline; }
.clue-item:hover { background: var(--paper-warm); }
.clue-item.active { background: var(--blue-select); border-radius: 4px; padding: 4px 4px; }
.clue-item-num { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--gold-dim); min-width: 20px; }
.clue-item-text { font-size: 0.8rem; color: var(--ink-soft); }
.clue-item.completed .clue-item-text { text-decoration: line-through; color: var(--ink-faint); }

/* ‚ïê‚ïê‚ïê WORD SEARCH ‚ïê‚ïê‚ïê */
#screenWordSearch { flex-direction: column; align-items: stretch; overflow: hidden; }
.ws-word-bank {
  display: flex; flex-wrap: wrap; gap: 6px 12px;
  padding: 8px 12px; background: var(--paper-warm);
  border-bottom: 1px solid var(--paper-dim);
  max-height: 80px; overflow-y: auto;
  -webkit-overflow-scrolling: touch; flex-shrink: 0;
}
.ws-word {
  font-family: 'DM Mono', monospace; font-size: 0.72rem;
  font-weight: 500; color: var(--ink-soft); letter-spacing: 1px;
  text-transform: uppercase; padding: 2px 6px; border-radius: 4px;
  background: var(--paper); border: 1px solid var(--paper-dim);
  transition: all 0.3s;
}
.ws-word.found {
  text-decoration: line-through; color: var(--ink-faint);
  background: var(--sage-light); border-color: var(--sage-light);
}

/* ‚ïê‚ïê‚ïê WIN ‚ïê‚ïê‚ïê */
#screenWin { justify-content: center; padding: 24px; text-align: center; position: relative; overflow: hidden; }
.win-ornament { font-size: 3.5rem; margin-bottom: 12px; }
.win-title { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: 800; margin-bottom: 6px; }
.win-subtitle { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--ink-faint); margin-bottom: 20px; }
.win-stats { display: flex; gap: 24px; justify-content: center; margin-bottom: 24px; }
.win-stat-val { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 800; color: var(--gold); }
.win-stat-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--ink-faint); letter-spacing: 2px; text-transform: uppercase; }
.win-scores { display: flex; flex-direction: column; gap: 16px; justify-content: center; margin-bottom: 20px; }

@keyframes trophy-bounce {
  0% { transform: scale(0) rotate(-20deg); opacity: 0; }
  50% { transform: scale(1.3) rotate(5deg); opacity: 1; }
  70% { transform: scale(0.9) rotate(-3deg); }
  100% { transform: scale(1) rotate(0deg); }
}
@keyframes trophy-glow {
  0%, 100% { filter: drop-shadow(0 0 8px rgba(196,148,62,0.3)); }
  50% { filter: drop-shadow(0 0 20px rgba(196,148,62,0.7)); }
}
@keyframes win-reveal {
  0% { opacity: 0; transform: translateY(20px) scale(0.9); }
  60% { opacity: 1; transform: translateY(-4px) scale(1.02); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes stat-pop {
  0% { transform: scale(0); opacity: 0; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}
.win-stats { animation: stat-pop 0.5s ease-out 0.4s both; }
.win-scores { animation: stat-pop 0.5s ease-out 0.7s both; }

.btn-outline-sm {
  background: none; border: 1px solid var(--ink-faint); border-radius: 6px;
  font-family: 'DM Mono', monospace; cursor: pointer; color: var(--ink-faint);
}

.loading-spinner {
  display: inline-block; width: 18px; height: 18px;
  border: 2px solid var(--paper-dim); border-top-color: var(--gold);
  border-radius: 50%; animation: spin 0.8s linear infinite;
  margin-right: 8px; vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }
.puzzle-status { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--ink-faint); margin-top: 8px; text-align: center; min-height: 1.2em; }
</style>
</head>
<body>

<!-- SCREEN: LOBBY -->
<div id="screenLobby" class="screen active">
  <div class="lobby-masthead">
    <div class="lobby-rule"></div>
    <div class="lobby-title font-display">Maria's Word Vault</div>
    <div class="lobby-subtitle font-mono">Crosswords & Word Search</div>
  </div>
  <div class="lobby-card">
    <div class="lobby-section">
      <div class="lobby-label">Game</div>
      <div class="mode-row">
        <button class="mode-btn selected" onclick="setGameType('crossword', this)">üì∞ Crossword</button>
        <button class="mode-btn" onclick="setGameType('wordsearch', this)">üîç Word Search</button>
      </div>
    </div>
    <div class="lobby-section" id="nameSection">
      <div class="lobby-label">Wat Dey Call U</div>
      <input type="text" id="inputName" class="lobby-input" placeholder="Your name" maxlength="20" autocomplete="off">
    </div>
    <div id="cwLobbyOptions">
    <div class="lobby-section">
      <div class="lobby-label">Mode</div>
      <div class="mode-row">
        <button class="mode-btn selected" onclick="setMode('solo', this)">üß© Solo</button>
        <button class="mode-btn" onclick="setMode('collaborative', this)">ü§ùüèæ Co-op</button>
        <button class="mode-btn" onclick="setMode('competitive', this)">‚öîÔ∏è Vs</button>
      </div>
    </div>
    <div class="lobby-section" id="roomArea" style="display:none">
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button class="btn-primary btn-gold" style="flex:1;margin:0" id="btnCreate" onclick="createRoom()">Create Room</button>
      </div>
      <div class="lobby-label">‚Äî Or Join a Room ‚Äî</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input type="text" id="inputRoom" class="lobby-input" placeholder="Enter code" maxlength="5" style="text-transform:uppercase;font-family:'DM Mono',monospace;letter-spacing:3px;text-align:center;flex:1">
        <button class="btn-primary btn-sage" style="width:auto;margin:0;padding:12px 20px" onclick="joinRoom()">Join</button>
      </div>
    </div>
    <button class="btn-primary btn-gold" id="btnPlay" onclick="startGame()">Begin Puzzle</button>
    </div>
    <div id="wsLobbyOptions" style="display:none">
    <div class="lobby-section">
      <div class="lobby-label">Theme</div>
      <select id="wsThemeSelect" class="lobby-select" style="display:block">
        <option value="random">üé≤ Random</option>
      </select>
    </div>
    <div class="lobby-section">
      <div class="lobby-label">Stakes</div>
      <div class="mode-row">
        <button class="mode-btn" onclick="setRanked(false,this)">üòé Casual</button>
        <button class="mode-btn selected" onclick="setRanked(true,this)">üèÜ Ranked</button>
      </div>
      <div style="font-size:0.65rem;color:var(--ink-faint);margin-top:4px" id="rankedHint">Your time goes on the global leaderboard</div>
    </div>
    <button class="btn-primary btn-gold" onclick="startWordSearch()" style="width:100%">Begin Word Search</button>
    </div>
    <div id="puzzleStatus" class="puzzle-status"></div>
    <div class="lobby-links">
      <button onclick="showScreen('screenInstructions')">How to Play</button>
      <button onclick="showScreen('screenRankings')">üèÜ Rankings</button>
    </div>
  </div>
</div>

<!-- SCREEN: INSTRUCTIONS -->
<div id="screenInstructions" class="screen">
  <div class="instr-container">
    <button class="instr-back" onclick="showScreen('screenLobby')">‚Üê Back</button>
    <div class="instr-title font-display">How to Play</div>
    <div class="instr-rule"></div>
    <div class="instr-section">
      <div class="instr-heading">üì∞ Crossword</div>
      <div class="instr-text">Fill in every white square to complete all the words. Each puzzle is a <strong>7√ó7 mini crossword</strong> with words going across and down. Letters are shared where words cross.</div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">Crossword Controls</div>
      <div class="instr-text">
        <strong>Tap a cell</strong> to select it ‚Äî the active word highlights and the clue shows at the top.<br><br>
        <strong>Tap the same cell again</strong> to switch between Across and Down.<br><br>
        <strong>Type a letter</strong> on the keyboard ‚Äî the cursor advances automatically.<br><br>
        <strong>‚å´</strong> removes the letter or moves backward if empty.<br><br>
        <strong>‚ò∞</strong> opens the full clue list ‚Äî tap any clue to jump to that word.
      </div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">üîç Word Search</div>
      <div class="instr-text">Find hidden words in a letter grid. <strong>Drag your finger</strong> (or mouse) from the first letter to the last. Words can go horizontal, vertical, diagonal ‚Äî even backwards. The word bank at the top shows what you're looking for.</div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">City Themes</div>
      <div class="instr-text">Word search includes city-based themes ‚Äî pick a city and find landmarks, neighborhoods, and spots hidden in the grid.</div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">Crossword Modes</div>
      <div class="instr-text">
        üß© <strong>Solo</strong> ‚Äî Just you and the puzzle. Race the clock.<br><br>
        ü§ùüèæ <strong>Co-op</strong> ‚Äî Share a board in real time. One player creates a room, the other joins with the code.<br><br>
        ‚öîÔ∏è <strong>Vs</strong> ‚Äî Head-to-head on the same puzzle. Each player fills in their own letters ‚Äî most words wins.
      </div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">üèÜ Ranked Games</div>
      <div class="instr-text">In word search, toggle <strong>Ranked</strong> to post your time to the global leaderboard. Everyone who plays ranked can see each other's scores. Pick <strong>Casual</strong> to just vibe.</div>
    </div>
    <button class="btn-primary btn-sage" onclick="showScreen('screenLobby')" style="max-width:240px;margin:12px auto 0;display:block">Got It</button>
  </div>
</div>

<!-- SCREEN: RANKINGS -->
<div id="screenRankings" class="screen">
  <div class="instr-container">
    <button class="instr-back" onclick="showScreen('screenLobby')">‚Üê Back</button>
    <div class="instr-title font-display">üèÜ Ranking Pool</div>
    <div style="font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--ink-faint);text-align:center;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">Global Leaderboard</div>
    <div class="instr-rule"></div>
    <div class="instr-section">
      <div class="instr-heading">üì∞ Crossword Best Times</div>
      <div id="rankCrossword"></div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">üîç Word Search Best Times</div>
      <div id="rankWordSearch"></div>
    </div>
  </div>
</div>

<!-- SCREEN: WAITING -->
<div id="screenWaiting" class="screen">
  <div class="waiting-card">
    <div class="waiting-title font-display">Waiting for Player 2</div>
    <div class="waiting-label">Room Code</div>
    <div class="waiting-code" id="waitingRoomCode">-----</div>
    <div class="share-url" id="shareUrl" onclick="copyShareUrl()">tap to copy link</div>
    <div class="player-slots">
      <div class="player-slot connected"><div class="waiting-label">Player 1</div><div id="slotP1Name">---</div></div>
      <div class="player-slot" id="slotP2"><div class="waiting-label">Player 2</div><div id="slotP2Name">waiting...</div></div>
    </div>
    <button class="btn-outline-sm" onclick="leaveRoom()">Cancel</button>
  </div>
</div>

<!-- SCREEN: GAME -->
<div id="screenGame" class="screen">
  <div class="game-header">
    <button class="hud-back" onclick="leaveRoom()">‚úï</button>
    <div class="hud-title font-display" id="hudTitle">Puzzle</div>
    <div class="hud-right">
      <div class="hud-score font-mono" id="hudScore">0/6</div>
      <div class="hud-timer font-mono" id="hudTimer">0:00</div>
    </div>
  </div>
  <div class="clue-bar" onclick="scrollToActiveClue()">
    <span class="clue-bar-num" id="activeClueNum">‚Äî</span>
    <span class="clue-bar-text" id="activeClueText">Tap a cell to begin</span>
    <span style="font-size:1rem;color:var(--ink-faint);padding:0 4px;flex-shrink:0">‚ò∞</span>
  </div>
  <div class="grid-wrapper" id="gridWrapper">
    <div class="crossword-grid" id="crosswordGrid"></div>
  </div>
  <div class="dir-bar">
    <button class="dir-btn active" id="btnAcross" onclick="setDirection('across')">Across ‚Üí</button>
    <button class="dir-btn" id="btnDown" onclick="setDirection('down')">Down ‚Üì</button>
  </div>
  <div class="clue-drawer" id="clueDrawer">
    <div class="clue-section"><div class="clue-section-title">Across</div><div id="clueListAcross"></div></div>
    <div class="clue-section"><div class="clue-section-title">Down</div><div id="clueListDown"></div></div>
  </div>
  <div class="osk" id="osk">
    <div class="osk-row">
      <button class="osk-key" data-key="Q">Q</button><button class="osk-key" data-key="W">W</button><button class="osk-key" data-key="E">E</button><button class="osk-key" data-key="R">R</button><button class="osk-key" data-key="T">T</button><button class="osk-key" data-key="Y">Y</button><button class="osk-key" data-key="U">U</button><button class="osk-key" data-key="I">I</button><button class="osk-key" data-key="O">O</button><button class="osk-key" data-key="P">P</button>
    </div>
    <div class="osk-row">
      <button class="osk-key" data-key="A">A</button><button class="osk-key" data-key="S">S</button><button class="osk-key" data-key="D">D</button><button class="osk-key" data-key="F">F</button><button class="osk-key" data-key="G">G</button><button class="osk-key" data-key="H">H</button><button class="osk-key" data-key="J">J</button><button class="osk-key" data-key="K">K</button><button class="osk-key" data-key="L">L</button>
    </div>
    <div class="osk-row">
      <button class="osk-key wide accent" data-key="TOGGLE">‚áÑ DIR</button><button class="osk-key" data-key="Z">Z</button><button class="osk-key" data-key="X">X</button><button class="osk-key" data-key="C">C</button><button class="osk-key" data-key="V">V</button><button class="osk-key" data-key="B">B</button><button class="osk-key" data-key="N">N</button><button class="osk-key" data-key="M">M</button><button class="osk-key wide" data-key="BACKSPACE">‚å´</button>
    </div>
  </div>
</div>

<!-- SCREEN: WORD SEARCH GAME -->
<div id="screenWordSearch" class="screen">
  <div class="game-header">
    <button class="hud-back" onclick="exitWordSearch()">‚úï</button>
    <div class="hud-title font-display" id="wsHudTitle">Word Search</div>
    <div class="hud-right">
      <div class="hud-score font-mono" id="wsHudScore">0/8</div>
      <div class="hud-timer font-mono" id="wsHudTimer">0:00</div>
    </div>
  </div>
  <div class="ws-word-bank" id="wsWordBank"></div>
  <div class="grid-wrapper" id="wsGridWrapper">
    <canvas id="wsCanvas" style="touch-action:none;"></canvas>
  </div>
</div>

<!-- SCREEN: WIN -->
<div id="screenWin" class="screen">
  <canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999"></canvas>
  <div class="win-ornament" id="winOrnament">üèÜ</div>
  <div class="win-title font-display" id="winTitle">Puzzle Complete!</div>
  <div class="win-subtitle" id="winSubtitle"></div>
  <div class="win-stats" id="winStats"></div>
  <div class="win-scores" id="winScores" style="display:none"></div>
  <button class="btn-primary btn-gold" style="max-width:240px" onclick="backToLobby()">Run It Back</button>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/*  MARIA'S WORD VAULT ‚Äî Engine                   */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

firebase.initializeApp({
  apiKey: "AIzaSyDkqQsKeNwL4qL5e-J1P5S3UE1puzcOaC0",
  authDomain: "marias-word-vault.firebaseapp.com",
  databaseURL: "https://marias-word-vault-default-rtdb.firebaseio.com",
  projectId: "marias-word-vault",
  storageBucket: "marias-word-vault.firebasestorage.app",
  messagingSenderId: "605567866404",
  appId: "1:605567866404:web:9dc0e6543e20e11105eab1"
});
const db = firebase.database();

/* STATE */
const state = {
  playerName:'', playerId:'', roomCode:'', mode:'solo',
  gameType:'crossword', puzzle:null, grid:[],
  selectedCell:null, direction:'across',
  clues:{across:[],down:[]}, answers:{},
  scores:{p1:0,p2:0}, ranked:true,
  timerStart:null, timerInterval:null, roomRef:null,
  gameComplete:false,
};

/* ‚ïê‚ïê‚ïê EMBEDDED PUZZLES (7√ó7, CSP-verified) ‚ïê‚ïê‚ïê */
const EMBEDDED_PUZZLES = [{"title":"Daybreak","size":7,"gridData":[["S","A","C","#","F","A","T"],["A","G","O","#","E","R","A"],["D","E","T","R","A","C","T"],["#","#","T","O","T","#","#"],["S","T","A","T","U","T","E"],["P","I","G","#","R","O","W"],["A","P","E","#","E","Y","E"]],"clues":{"across":[{"number":1,"clue":"Pouch or bag","answer":"SAC","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Body type, not thin","answer":"FAT","row":0,"col":4,"dir":"across"},{"number":7,"clue":"In the past","answer":"AGO","row":1,"col":0,"dir":"across"},{"number":8,"clue":"Historical period","answer":"ERA","row":1,"col":4,"dir":"across"},{"number":9,"clue":"Take away from","answer":"DETRACT","row":2,"col":0,"dir":"across"},{"number":11,"clue":"Little one","answer":"TOT","row":3,"col":2,"dir":"across"},{"number":12,"clue":"A written law","answer":"STATUTE","row":4,"col":0,"dir":"across"},{"number":16,"clue":"Barnyard animal","answer":"PIG","row":5,"col":0,"dir":"across"},{"number":17,"clue":"A fight or argument","answer":"ROW","row":5,"col":4,"dir":"across"},{"number":18,"clue":"Copycat primate","answer":"APE","row":6,"col":0,"dir":"across"},{"number":19,"clue":"Organ of sight","answer":"EYE","row":6,"col":4,"dir":"across"}],"down":[{"number":1,"clue":"Unhappy","answer":"SAD","row":0,"col":0,"dir":"down"},{"number":2,"clue":"How old you are","answer":"AGE","row":0,"col":1,"dir":"down"},{"number":3,"clue":"Cozy little house","answer":"COTTAGE","row":0,"col":2,"dir":"down"},{"number":4,"clue":"Main attraction","answer":"FEATURE","row":0,"col":4,"dir":"down"},{"number":5,"clue":"Curved line","answer":"ARC","row":0,"col":5,"dir":"down"},{"number":6,"clue":"Cheap lace pattern","answer":"TAT","row":0,"col":6,"dir":"down"},{"number":10,"clue":"Decay or spoil","answer":"ROT","row":2,"col":3,"dir":"down"},{"number":12,"clue":"Relaxation retreat","answer":"SPA","row":4,"col":0,"dir":"down"},{"number":13,"clue":"Helpful hint","answer":"TIP","row":4,"col":1,"dir":"down"},{"number":14,"clue":"Plaything for a child","answer":"TOY","row":4,"col":5,"dir":"down"},{"number":15,"clue":"Female sheep","answer":"EWE","row":4,"col":6,"dir":"down"}]},"answers":{"across_1":"SAC","across_4":"FAT","across_7":"AGO","across_8":"ERA","across_9":"DETRACT","across_11":"TOT","across_12":"STATUTE","across_16":"PIG","across_17":"ROW","across_18":"APE","across_19":"EYE","down_1":"SAD","down_2":"AGE","down_3":"COTTAGE","down_4":"FEATURE","down_5":"ARC","down_6":"TAT","down_10":"ROT","down_12":"SPA","down_13":"TIP","down_14":"TOY","down_15":"EWE"}},{"title":"Sunrise","size":7,"gridData":[["S","O","P","#","G","O","D"],["A","I","R","#","R","A","Y"],["C","L","I","M","A","T","E"],["#","#","V","A","N","#","#"],["L","E","A","D","I","N","G"],["A","R","C","#","T","I","E"],["P","A","Y","#","E","L","M"]],"clues":{"across":[{"number":1,"clue":"Something soaked up","answer":"SOP","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Supreme being","answer":"GOD","row":0,"col":4,"dir":"across"},{"number":7,"clue":"Fresh oxygen","answer":"AIR","row":1,"col":0,"dir":"across"},{"number":8,"clue":"Beam of light","answer":"RAY","row":1,"col":4,"dir":"across"},{"number":9,"clue":"Weather patterns over time","answer":"CLIMATE","row":2,"col":0,"dir":"across"},{"number":11,"clue":"Moving truck","answer":"VAN","row":3,"col":2,"dir":"across"},{"number":12,"clue":"Ahead of the pack","answer":"LEADING","row":4,"col":0,"dir":"across"},{"number":16,"clue":"Rainbow shape","answer":"ARC","row":5,"col":0,"dir":"across"},{"number":17,"clue":"Knot a necktie","answer":"TIE","row":5,"col":4,"dir":"across"},{"number":18,"clue":"Earn wages","answer":"PAY","row":6,"col":0,"dir":"across"},{"number":19,"clue":"Shady tree","answer":"ELM","row":6,"col":4,"dir":"across"}],"down":[{"number":1,"clue":"Small bag","answer":"SAC","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Engine lubricant","answer":"OIL","row":0,"col":1,"dir":"down"},{"number":3,"clue":"Keeping secrets","answer":"PRIVACY","row":0,"col":2,"dir":"down"},{"number":4,"clue":"Hard speckled rock","answer":"GRANITE","row":0,"col":4,"dir":"down"},{"number":5,"clue":"Breakfast cereal grain","answer":"OAT","row":0,"col":5,"dir":"down"},{"number":6,"clue":"Color fabric","answer":"DYE","row":0,"col":6,"dir":"down"},{"number":10,"clue":"Angry, furious","answer":"MAD","row":2,"col":3,"dir":"down"},{"number":12,"clue":"Sit on Santa's ___","answer":"LAP","row":4,"col":0,"dir":"down"},{"number":13,"clue":"Time period","answer":"ERA","row":4,"col":1,"dir":"down"},{"number":14,"clue":"Zero, nothing","answer":"NIL","row":4,"col":5,"dir":"down"},{"number":15,"clue":"Precious stone","answer":"GEM","row":4,"col":6,"dir":"down"}]},"answers":{"across_1":"SOP","across_4":"GOD","across_7":"AIR","across_8":"RAY","across_9":"CLIMATE","across_11":"VAN","across_12":"LEADING","across_16":"ARC","across_17":"TIE","across_18":"PAY","across_19":"ELM","down_1":"SAC","down_2":"OIL","down_3":"PRIVACY","down_4":"GRANITE","down_5":"OAT","down_6":"DYE","down_10":"MAD","down_12":"LAP","down_13":"ERA","down_14":"NIL","down_15":"GEM"}},{"title":"Daylight","size":7,"gridData":[["S","E","W","#","G","A","S"],["P","E","A","#","R","I","P"],["A","L","R","E","A","D","Y"],["#","#","R","A","N","#","#"],["H","E","A","R","I","N","G"],["U","R","N","#","T","I","E"],["B","A","T","#","E","L","M"]],"clues":{"across":[{"number":1,"clue":"Stitch with a needle","answer":"SEW","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Fill up the tank","answer":"GAS","row":0,"col":4,"dir":"across"},{"number":7,"clue":"Green veggie in a pod","answer":"PEA","row":1,"col":0,"dir":"across"},{"number":8,"clue":"Tear apart","answer":"RIP","row":1,"col":4,"dir":"across"},{"number":9,"clue":"By this time","answer":"ALREADY","row":2,"col":0,"dir":"across"},{"number":11,"clue":"Jogged quickly","answer":"RAN","row":3,"col":2,"dir":"across"},{"number":12,"clue":"Court proceeding","answer":"HEARING","row":4,"col":0,"dir":"across"},{"number":16,"clue":"Vase for ashes","answer":"URN","row":5,"col":0,"dir":"across"},{"number":17,"clue":"Draw, make even","answer":"TIE","row":5,"col":4,"dir":"across"},{"number":18,"clue":"Baseball stick","answer":"BAT","row":6,"col":0,"dir":"across"},{"number":19,"clue":"Street tree","answer":"ELM","row":6,"col":4,"dir":"across"}],"down":[{"number":1,"clue":"Day at the ___","answer":"SPA","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Slippery fish","answer":"EEL","row":0,"col":1,"dir":"down"},{"number":3,"clue":"Guarantee or promise","answer":"WARRANT","row":0,"col":2,"dir":"down"},{"number":4,"clue":"Hard speckled rock","answer":"GRANITE","row":0,"col":4,"dir":"down"},{"number":5,"clue":"Help or assist","answer":"AID","row":0,"col":5,"dir":"down"},{"number":6,"clue":"Secret agent","answer":"SPY","row":0,"col":6,"dir":"down"},{"number":10,"clue":"Lobe location","answer":"EAR","row":2,"col":3,"dir":"down"},{"number":12,"clue":"Center of a wheel","answer":"HUB","row":4,"col":0,"dir":"down"},{"number":13,"clue":"Time period","answer":"ERA","row":4,"col":1,"dir":"down"},{"number":14,"clue":"Nothing at all","answer":"NIL","row":4,"col":5,"dir":"down"},{"number":15,"clue":"Precious stone","answer":"GEM","row":4,"col":6,"dir":"down"}]},"answers":{"across_1":"SEW","across_4":"GAS","across_7":"PEA","across_8":"RIP","across_9":"ALREADY","across_11":"RAN","across_12":"HEARING","across_16":"URN","across_17":"TIE","across_18":"BAT","across_19":"ELM","down_1":"SPA","down_2":"EEL","down_3":"WARRANT","down_4":"GRANITE","down_5":"AID","down_6":"SPY","down_10":"EAR","down_12":"HUB","down_13":"ERA","down_14":"NIL","down_15":"GEM"}},{"title":"Midday","size":7,"gridData":[["C","O","P","#","H","E","R"],["A","I","R","#","O","W","E"],["P","L","E","A","S","E","D"],["#","#","P","I","T","#","#"],["T","R","A","D","I","N","G"],["W","A","R","#","L","I","E"],["O","N","E","#","E","L","M"]],"clues":{"across":[{"number":1,"clue":"Police officer","answer":"COP","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Belonging to she","answer":"HER","row":0,"col":4,"dir":"across"},{"number":7,"clue":"Breathe this","answer":"AIR","row":1,"col":0,"dir":"across"},{"number":8,"clue":"Be in debt","answer":"OWE","row":1,"col":4,"dir":"across"},{"number":9,"clue":"Happy, satisfied","answer":"PLEASED","row":2,"col":0,"dir":"across"},{"number":11,"clue":"Deep hole in the ground","answer":"PIT","row":3,"col":2,"dir":"across"},{"number":12,"clue":"Buying and selling","answer":"TRADING","row":4,"col":0,"dir":"across"},{"number":16,"clue":"Armed conflict","answer":"WAR","row":5,"col":0,"dir":"across"},{"number":17,"clue":"Fib, not truth","answer":"LIE","row":5,"col":4,"dir":"across"},{"number":18,"clue":"Single number","answer":"ONE","row":6,"col":0,"dir":"across"},{"number":19,"clue":"Shade tree","answer":"ELM","row":6,"col":4,"dir":"across"}],"down":[{"number":1,"clue":"Hat or lid","answer":"CAP","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Cooking liquid","answer":"OIL","row":0,"col":1,"dir":"down"},{"number":3,"clue":"Get ready for","answer":"PREPARE","row":0,"col":2,"dir":"down"},{"number":4,"clue":"Unfriendly, mean","answer":"HOSTILE","row":0,"col":4,"dir":"down"},{"number":5,"clue":"Female sheep","answer":"EWE","row":0,"col":5,"dir":"down"},{"number":6,"clue":"Color like a rose","answer":"RED","row":0,"col":6,"dir":"down"},{"number":10,"clue":"Help out","answer":"AID","row":2,"col":3,"dir":"down"},{"number":12,"clue":"The number after one","answer":"TWO","row":4,"col":0,"dir":"down"},{"number":13,"clue":"Sprinted","answer":"RAN","row":4,"col":1,"dir":"down"},{"number":14,"clue":"Zero, zilch","answer":"NIL","row":4,"col":5,"dir":"down"},{"number":15,"clue":"Jewel","answer":"GEM","row":4,"col":6,"dir":"down"}]},"answers":{"across_1":"COP","across_4":"HER","across_7":"AIR","across_8":"OWE","across_9":"PLEASED","across_11":"PIT","across_12":"TRADING","across_16":"WAR","across_17":"LIE","across_18":"ONE","across_19":"ELM","down_1":"CAP","down_2":"OIL","down_3":"PREPARE","down_4":"HOSTILE","down_5":"EWE","down_6":"RED","down_10":"AID","down_12":"TWO","down_13":"RAN","down_14":"NIL","down_15":"GEM"}},{"title":"Sunset","size":7,"gridData":[["D","E","W","#","T","W","O"],["A","W","E","#","H","O","P"],["D","E","S","C","E","N","T"],["#","#","T","A","R","#","#"],["O","V","E","R","A","L","L"],["A","I","R","#","P","I","E"],["K","E","N","#","Y","E","T"]],"clues":{"across":[{"number":1,"clue":"Morning moisture","answer":"DEW","row":0,"col":0,"dir":"across"},{"number":4,"clue":"A pair","answer":"TWO","row":0,"col":4,"dir":"across"},{"number":7,"clue":"Jaw-dropping wonder","answer":"AWE","row":1,"col":0,"dir":"across"},{"number":8,"clue":"Quick jump","answer":"HOP","row":1,"col":4,"dir":"across"},{"number":9,"clue":"Going downward","answer":"DESCENT","row":2,"col":0,"dir":"across"},{"number":11,"clue":"Sticky road surface","answer":"TAR","row":3,"col":2,"dir":"across"},{"number":12,"clue":"All things considered","answer":"OVERALL","row":4,"col":0,"dir":"across"},{"number":16,"clue":"What we breathe","answer":"AIR","row":5,"col":0,"dir":"across"},{"number":17,"clue":"Dessert with a crust","answer":"PIE","row":5,"col":4,"dir":"across"},{"number":18,"clue":"Range of knowledge","answer":"KEN","row":6,"col":0,"dir":"across"},{"number":19,"clue":"Up to now","answer":"YET","row":6,"col":4,"dir":"across"}],"down":[{"number":1,"clue":"Father","answer":"DAD","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Female sheep","answer":"EWE","row":0,"col":1,"dir":"down"},{"number":3,"clue":"Cowboy movie genre","answer":"WESTERN","row":0,"col":2,"dir":"down"},{"number":4,"clue":"Counseling treatment","answer":"THERAPY","row":0,"col":4,"dir":"down"},{"number":5,"clue":"Came in first","answer":"WON","row":0,"col":5,"dir":"down"},{"number":6,"clue":"Choose, pick","answer":"OPT","row":0,"col":6,"dir":"down"},{"number":10,"clue":"Drive this vehicle","answer":"CAR","row":2,"col":3,"dir":"down"},{"number":12,"clue":"Strong tree","answer":"OAK","row":4,"col":0,"dir":"down"},{"number":13,"clue":"Compete with","answer":"VIE","row":4,"col":1,"dir":"down"},{"number":14,"clue":"Untruth","answer":"LIE","row":4,"col":5,"dir":"down"},{"number":15,"clue":"Allow, permit","answer":"LET","row":4,"col":6,"dir":"down"}]},"answers":{"across_1":"DEW","across_4":"TWO","across_7":"AWE","across_8":"HOP","across_9":"DESCENT","across_11":"TAR","across_12":"OVERALL","across_16":"AIR","across_17":"PIE","across_18":"KEN","across_19":"YET","down_1":"DAD","down_2":"EWE","down_3":"WESTERN","down_4":"THERAPY","down_5":"WON","down_6":"OPT","down_10":"CAR","down_12":"OAK","down_13":"VIE","down_14":"LIE","down_15":"LET"}},{"title":"Reunion","size":7,"gridData":[["S","O","P","#","S","H","Y"],["A","I","R","#","P","I","E"],["C","L","O","S","E","S","T"],["#","#","D","O","C","#","#"],["R","E","U","N","I","O","N"],["A","R","C","#","A","R","E"],["M","A","T","#","L","E","T"]],"clues":{"across":[{"number":1,"clue":"Something soaked up","answer":"SOP","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Timid, bashful","answer":"SHY","row":0,"col":4,"dir":"across"},{"number":7,"clue":"Fresh oxygen","answer":"AIR","row":1,"col":0,"dir":"across"},{"number":8,"clue":"Slice of dessert","answer":"PIE","row":1,"col":4,"dir":"across"},{"number":9,"clue":"Nearest of all","answer":"CLOSEST","row":2,"col":0,"dir":"across"},{"number":11,"clue":"Doctor, for short","answer":"DOC","row":3,"col":2,"dir":"across"},{"number":12,"clue":"Family get-together","answer":"REUNION","row":4,"col":0,"dir":"across"},{"number":16,"clue":"Rainbow shape","answer":"ARC","row":5,"col":0,"dir":"across"},{"number":17,"clue":"To exist","answer":"ARE","row":5,"col":4,"dir":"across"},{"number":18,"clue":"Doorway rug","answer":"MAT","row":6,"col":0,"dir":"across"},{"number":19,"clue":"Allow","answer":"LET","row":6,"col":4,"dir":"across"}],"down":[{"number":1,"clue":"Small bag","answer":"SAC","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Engine lubricant","answer":"OIL","row":0,"col":1,"dir":"down"},{"number":3,"clue":"Something you make","answer":"PRODUCT","row":0,"col":2,"dir":"down"},{"number":4,"clue":"Unique, one of a kind","answer":"SPECIAL","row":0,"col":4,"dir":"down"},{"number":5,"clue":"Belonging to him","answer":"HIS","row":0,"col":5,"dir":"down"},{"number":6,"clue":"Up to now","answer":"YET","row":0,"col":6,"dir":"down"},{"number":10,"clue":"Male child","answer":"SON","row":2,"col":3,"dir":"down"},{"number":12,"clue":"Male goat","answer":"RAM","row":4,"col":0,"dir":"down"},{"number":13,"clue":"Time period","answer":"ERA","row":4,"col":1,"dir":"down"},{"number":14,"clue":"Mineral rock","answer":"ORE","row":4,"col":5,"dir":"down"},{"number":15,"clue":"Fishing trap","answer":"NET","row":4,"col":6,"dir":"down"}]},"answers":{"across_1":"SOP","across_4":"SHY","across_7":"AIR","across_8":"PIE","across_9":"CLOSEST","across_11":"DOC","across_12":"REUNION","across_16":"ARC","across_17":"ARE","across_18":"MAT","across_19":"LET","down_1":"SAC","down_2":"OIL","down_3":"PRODUCT","down_4":"SPECIAL","down_5":"HIS","down_6":"YET","down_10":"SON","down_12":"RAM","down_13":"ERA","down_14":"ORE","down_15":"NET"}}];

function getEmbeddedPuzzle() {
  const p = EMBEDDED_PUZZLES[Math.floor(Math.random()*EMBEDDED_PUZZLES.length)];
  return {source:'embedded', ...p};
}

/* ‚ïê‚ïê‚ïê UI HELPERS ‚ïê‚ïê‚ïê */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'screenRankings') {
    // Load from Firebase (global leaderboard)
    document.getElementById('rankCrossword').innerHTML = '<div style="color:var(--ink-faint);font-size:0.75rem;text-align:center;padding:8px">Loading‚Ä¶</div>';
    document.getElementById('rankWordSearch').innerHTML = '<div style="color:var(--ink-faint);font-size:0.75rem;text-align:center;padding:8px">Loading‚Ä¶</div>';
    getFirebaseRankings('crossword').then(r => {
      document.getElementById('rankCrossword').innerHTML = buildRankingHTML(r, 10);
    });
    getFirebaseRankings('wordsearch').then(r => {
      document.getElementById('rankWordSearch').innerHTML = buildRankingHTML(r, 10);
    });
  }
}
function setMode(mode, el) {
  state.mode = mode;
  if (el) {
    el.parentElement.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
  }
  const roomArea = document.getElementById('roomArea');
  const btnPlay = document.getElementById('btnPlay');
  if (mode === 'solo') {
    roomArea.style.display='none';
    btnPlay.style.display='';
  } else {
    roomArea.style.display='';
    btnPlay.style.display='none';
  }
}
function setDirection(dir) {
  state.direction = dir;
  document.getElementById('btnAcross').classList.toggle('active', dir==='across');
  document.getElementById('btnDown').classList.toggle('active', dir==='down');
  if (state.selectedCell) { highlightWord(); updateActiveClue(); }
}
function toggleClueDrawer() { document.getElementById('clueDrawer').classList.toggle('open'); }
function setRanked(val, el) {
  state.ranked = val;
  if (el) {
    el.parentElement.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
  }
  document.getElementById('rankedHint').textContent = val
    ? 'Your time goes on the global leaderboard'
    : 'Just vibes ‚Äî no scores saved';
}

/* ‚ïê‚ïê‚ïê GAME FLOW ‚ïê‚ïê‚ïê */
function startGame() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { document.getElementById('inputName').focus(); return; }
  state.playerName=name; state.playerId='solo'; state.mode='solo';
  state.puzzle = getEmbeddedPuzzle();
  initGame();
}
function createRoom() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { document.getElementById('inputName').focus(); return; }
  state.playerName=name; state.playerId='p1';
  state.roomCode = genRoomCode();
  state.puzzle = getEmbeddedPuzzle();
  const ref = db.ref('rooms/'+state.roomCode);
  state.roomRef = ref;
  ref.set({
    p1:{name:state.playerName,connected:true}, p2:{name:'',connected:false},
    mode:state.mode, puzzle:state.puzzle, cells:{}, scores:{p1:0,p2:0}, cursors:{},
    status:'waiting', timerStart:null,
    created:firebase.database.ServerValue.TIMESTAMP
  });
  document.getElementById('waitingRoomCode').textContent = state.roomCode;
  const link = `${location.origin}${location.pathname}?room=${state.roomCode}`;
  document.getElementById('shareUrl').textContent = link;
  document.getElementById('slotP1Name').textContent = state.playerName;
  showScreen('screenWaiting');
  ref.child('p2').on('value', snap => {
    const p2 = snap.val();
    if (p2 && p2.connected) {
      document.getElementById('slotP2').classList.add('connected');
      document.getElementById('slotP2Name').textContent = p2.name;
      ref.update({status:'playing', timerStart:firebase.database.ServerValue.TIMESTAMP});
      initGame();
    }
  });
}
function joinRoom() {
  const name = document.getElementById('inputName').value.trim();
  const code = document.getElementById('inputRoom').value.trim().toUpperCase();
  if (!name) { document.getElementById('inputName').focus(); return; }
  if (!code||code.length<4) { document.getElementById('inputRoom').focus(); return; }
  state.playerName=name; state.roomCode=code; state.playerId='p2';
  const ref = db.ref('rooms/'+code);
  state.roomRef = ref;
  ref.once('value').then(snap => {
    if (!snap.exists()) { alert('Room not found!'); return; }
    const room = snap.val();
    state.mode = room.mode; state.puzzle = room.puzzle;
    ref.child('p2').set({name:state.playerName,connected:true});
    ref.child('status').on('value', s => { if (s.val()==='playing') initGame(); });
    document.getElementById('waitingRoomCode').textContent = code;
    document.getElementById('slotP1Name').textContent = room.p1.name;
    document.getElementById('slotP2Name').textContent = state.playerName;
    document.getElementById('slotP2').classList.add('connected');
    showScreen('screenWaiting');
  });
}
function genRoomCode() {
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ'; let s='';
  for (let i=0;i<5;i++) s+=c[Math.floor(Math.random()*c.length)];
  return s;
}
function copyShareUrl() {
  const el = document.getElementById('shareUrl');
  const t = el.textContent;
  navigator.clipboard?.writeText(t);
  el.textContent = '‚úì Copied!';
  setTimeout(()=>{ el.textContent=t; }, 2000);
}

/* ‚ïê‚ïê‚ïê INIT GAME ‚ïê‚ïê‚ïê */
function saveGameState() {
  if (!state.puzzle || state.mode !== 'solo') return;
  try {
    const filledCells = {};
    const rows = state.grid.length, cols = state.grid[0].length;
    for (let r=0;r<rows;r++) for (let c=0;c<cols;c++) {
      const v = state.grid[r][c].filled?.shared || '';
      if (v) filledCells[`${r}_${c}`] = v;
    }
    const data = {
      puzzleTitle: state.puzzle.title,
      filledCells,
      timerStart: state.timerStart,
      elapsed: Date.now() - state.timerStart,
      puzzle: state.puzzle,
      playerName: state.playerName,
    };
    localStorage.setItem('mwv_save', JSON.stringify(data));
  } catch(e) {}
}
function restoreGameState() {
  try {
    const raw = localStorage.getItem('mwv_save');
    if (!raw) return false;
    const data = JSON.parse(raw);
    if (!data.puzzle || !data.filledCells) return false;
    state.puzzle = data.puzzle;
    state.playerName = data.playerName || 'Player';
    state.mode = 'solo';
    state.playerId = 'solo';
    document.getElementById('inputName').value = state.playerName;
    initGame();
    // Restore filled cells
    const rows = state.grid.length, cols = state.grid[0].length;
    for (let r=0;r<rows;r++) for (let c=0;c<cols;c++) {
      const v = data.filledCells[`${r}_${c}`];
      if (v) {
        state.grid[r][c].filled.shared = v;
        const el = document.querySelector(`.grid-cell[data-row="${r}"][data-col="${c}"] .cell-letter`);
        if (el) el.textContent = v;
      }
    }
    // Restore timer
    state.timerStart = Date.now() - (data.elapsed || 0);
    return true;
  } catch(e) { return false; }
}
function clearSavedGame() {
  try { localStorage.removeItem('mwv_save'); } catch(e) {}
}
function initGame() {
  state.gameComplete=false; state.scores={p1:0,p2:0};
  state.selectedCell=null; state.direction='across';
  const puzzle = state.puzzle;
  const gd = puzzle.gridData;
  const rows = gd.length, cols = gd[0].length;
  state.grid = [];
  for (let r=0;r<rows;r++) {
    state.grid[r]=[];
    for (let c=0;c<cols;c++) {
      const isBlack = gd[r][c]==='#';
      state.grid[r][c] = {
        letter: isBlack?'#':gd[r][c], isBlack, number:null,
        filled:{shared:'',p1:'',p2:''}, acrossClue:null, downClue:null
      };
    }
  }
  state.clues = puzzle.clues;
  state.answers = puzzle.answers||{};
  for (const dir of ['across','down']) {
    for (const clue of state.clues[dir]) {
      if (state.grid[clue.row]?.[clue.col]) state.grid[clue.row][clue.col].number = clue.number;
      for (let i=0;i<clue.answer.length;i++) {
        const r = clue.dir==='across'?clue.row:clue.row+i;
        const c = clue.dir==='across'?clue.col+i:clue.col;
        if (state.grid[r]?.[c]) {
          if (dir==='across') state.grid[r][c].acrossClue=clue;
          else state.grid[r][c].downClue=clue;
        }
      }
    }
  }
  document.getElementById('hudTitle').textContent = puzzle.title||'Puzzle';
  buildGrid(rows,cols);
  buildCluePanel();
  state.timerStart = Date.now();
  clearInterval(state.timerInterval);
  state.timerInterval = setInterval(updateTimer, 1000);
  document.getElementById('hudScore').textContent = '0/'+( state.clues.across.length+state.clues.down.length);
  showScreen('screenGame');
  // Must recalculate after screen is visible so clientWidth/Height are non-zero
  requestAnimationFrame(()=>{ calcCellSize(rows,cols); });
  if (state.mode!=='solo' && state.roomRef) listenRoom();
  window.addEventListener('resize', ()=>calcCellSize(rows,cols));
}

function calcCellSize(rows, cols) {
  const w = document.getElementById('gridWrapper');
  if (!w) return;
  const aW = w.clientWidth-16, aH = w.clientHeight-16;
  const cs = Math.min(Math.floor(aW/cols), Math.floor(aH/rows), 72);
  document.getElementById('crosswordGrid').style.setProperty('--cell-size', cs+'px');
}

function buildGrid(rows, cols) {
  const g = document.getElementById('crosswordGrid');
  g.innerHTML='';
  g.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;
  g.style.gridTemplateRows = `repeat(${rows}, var(--cell-size))`;
  for (let r=0;r<rows;r++) {
    for (let c=0;c<cols;c++) {
      const cell = document.createElement('div');
      cell.className='grid-cell'; cell.dataset.row=r; cell.dataset.col=c;
      const d = state.grid[r][c];
      if (d.isBlack) { cell.classList.add('black'); }
      else {
        if (d.number) { const n=document.createElement('span'); n.className='cell-number'; n.textContent=d.number; cell.appendChild(n); }
        const l = document.createElement('span'); l.className='cell-letter'; l.id=`letter_${r}_${c}`; cell.appendChild(l);
        cell.addEventListener('click', ()=>handleCellClick(r,c));
      }
      g.appendChild(cell);
    }
  }
}

function buildCluePanel() {
  for (const dir of ['across','down']) {
    const ct = document.getElementById(dir==='across'?'clueListAcross':'clueListDown');
    ct.innerHTML='';
    for (const clue of state.clues[dir]) {
      const item = document.createElement('div');
      item.className='clue-item'; item.id=`clue_${dir}_${clue.number}`;
      item.innerHTML = `<span class="clue-item-num">${clue.number}</span><span class="clue-item-text">${clue.clue}</span>`;
      item.addEventListener('click', ()=>{
        state.direction=dir;
        document.getElementById('btnAcross').classList.toggle('active',dir==='across');
        document.getElementById('btnDown').classList.toggle('active',dir==='down');
        handleCellClick(clue.row, clue.col);
        document.getElementById('clueDrawer').classList.remove('open');
      });
      ct.appendChild(item);
    }
  }
}

/* ‚ïê‚ïê‚ïê CELL INTERACTION ‚ïê‚ïê‚ïê */
function handleCellClick(r,c) {
  if (state.grid[r][c].isBlack) return;
  if (state.selectedCell && state.selectedCell.row===r && state.selectedCell.col===c) {
    state.direction = state.direction==='across'?'down':'across';
    document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
    document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
  }
  state.selectedCell={row:r,col:c};
  highlightWord(); updateActiveClue();
  if (state.roomRef) state.roomRef.child(`cursors/${state.playerId}`).set({row:r,col:c});
}

function highlightWord() {
  document.querySelectorAll('.grid-cell').forEach(e => e.classList.remove('selected','word-highlight'));
  if (!state.selectedCell) return;
  const {row,col}=state.selectedCell;
  const cd = state.grid[row][col];
  let clue = state.direction==='across'?cd.acrossClue:cd.downClue;
  if (!clue) {
    const alt = state.direction==='across'?cd.downClue:cd.acrossClue;
    if (alt) {
      state.direction = state.direction==='across'?'down':'across';
      document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
      document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
      clue=alt;
    }
  }
  if (clue) {
    for (let i=0;i<clue.answer.length;i++) {
      const cr=clue.dir==='across'?clue.row:clue.row+i;
      const cc=clue.dir==='across'?clue.col+i:clue.col;
      const el=getCellEl(cr,cc); if(el) el.classList.add('word-highlight');
    }
  }
  const ae=getCellEl(row,col); if(ae) ae.classList.add('selected');
}

function updateActiveClue() {
  if (!state.selectedCell) return;
  const {row,col}=state.selectedCell;
  const cd=state.grid[row][col];
  const clue = state.direction==='across'?cd.acrossClue:cd.downClue;
  // Remove old highlight
  document.querySelectorAll('.clue-item.active').forEach(el => el.classList.remove('active'));
  if (clue) {
    document.getElementById('activeClueNum').textContent = `${clue.number}${clue.dir==='across'?'A':'D'}`;
    document.getElementById('activeClueText').textContent = clue.clue;
    // Highlight active clue in panel
    const clueEl = document.getElementById(`clue_${clue.dir}_${clue.number}`);
    if (clueEl) {
      clueEl.classList.add('active');
      clueEl.scrollIntoView({block:'nearest',behavior:'smooth'});
    }
  }
}

function getCellEl(r,c) { return document.querySelector(`.grid-cell[data-row="${r}"][data-col="${c}"]`); }

/* ‚ïê‚ïê‚ïê KEYBOARD ‚ïê‚ïê‚ïê */

document.addEventListener('keydown', e => {
  if (!state.selectedCell) return;
  if (document.activeElement?.tagName==='INPUT'||document.activeElement?.tagName==='SELECT') return;
  if (e.key==='ArrowUp'){e.preventDefault();moveSelection(0,-1);return;}
  if (e.key==='ArrowDown'){e.preventDefault();moveSelection(0,1);return;}
  if (e.key==='ArrowLeft'){e.preventDefault();moveSelection(-1,0);return;}
  if (e.key==='ArrowRight'){e.preventDefault();moveSelection(1,0);return;}
  if (e.key==='Tab'||e.key===' '){
    e.preventDefault();
    state.direction=state.direction==='across'?'down':'across';
    document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
    document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
    highlightWord();updateActiveClue();return;
  }
  if (e.key==='Backspace'||e.key==='Delete'){e.preventDefault();handleBackspace();return;}
  const l=e.key.toUpperCase();
  if (/^[A-Z]$/.test(l)){e.preventDefault();typeLetter(l);}
});

function typeLetter(l) {
  if (!state.selectedCell||state.gameComplete) return;
  setLetter(state.selectedCell.row,state.selectedCell.col,l);
  advanceCursor();
  saveGameState();
}

function handleBackspace() {
  if (!state.selectedCell||state.gameComplete) return;
  const {row,col}=state.selectedCell;
  if (getDisplayed(row,col)) { setLetter(row,col,''); }
  else { retreatCursor(); if (state.selectedCell) setLetter(state.selectedCell.row,state.selectedCell.col,''); }
  saveGameState();
}

function getDisplayed(r,c) {
  return state.mode==='competitive'?(state.grid[r][c].filled[state.playerId]||''):(state.grid[r][c].filled.shared||'');
}

function setLetter(row,col,letter) {
  if (state.mode==='solo') {
    state.grid[row][col].filled.shared=letter;
    updateCellDisplay(row,col); checkCompletion();
  } else if (state.roomRef) {
    const k=`${row}_${col}`;
    if (state.mode==='collaborative') {
      state.roomRef.child(`cells/${k}`).set({letter,owner:state.playerId});
      state.grid[row][col].filled.shared=letter;
    } else {
      state.roomRef.child(`cells/${k}/${state.playerId}`).set(letter);
      state.grid[row][col].filled[state.playerId]=letter;
    }
    updateCellDisplay(row,col); checkCompletion();
  }
}

function updateCellDisplay(r,c) {
  const el=document.getElementById(`letter_${r}_${c}`); if(!el) return;
  el.textContent = state.mode==='competitive'?(state.grid[r][c].filled[state.playerId]||''):(state.grid[r][c].filled.shared||'');
}

function advanceCursor() {
  if (!state.selectedCell) return;
  let {row,col}=state.selectedCell;
  const R=state.grid.length, C=state.grid[0].length;
  if (state.direction==='across') { col++; while(col<C&&state.grid[row][col].isBlack) col++; if(col>=C) return; }
  else { row++; while(row<R&&state.grid[row][col].isBlack) row++; if(row>=R) return; }
  state.selectedCell={row,col}; highlightWord(); updateActiveClue();
  if (state.roomRef) state.roomRef.child(`cursors/${state.playerId}`).set({row,col});
}

function retreatCursor() {
  if (!state.selectedCell) return;
  let {row,col}=state.selectedCell;
  if (state.direction==='across') { col--; while(col>=0&&state.grid[row][col].isBlack) col--; if(col<0) return; }
  else { row--; while(row>=0&&state.grid[row][col].isBlack) row--; if(row<0) return; }
  state.selectedCell={row,col}; highlightWord(); updateActiveClue();
}

function moveSelection(dx,dy) {
  if (!state.selectedCell) return;
  let {row,col}=state.selectedCell;
  const R=state.grid.length, C=state.grid[0].length;
  let nr=row+dy, nc=col+dx;
  while(nr>=0&&nr<R&&nc>=0&&nc<C&&state.grid[nr][nc].isBlack){nr+=dy;nc+=dx;}
  if(nr>=0&&nr<R&&nc>=0&&nc<C&&!state.grid[nr][nc].isBlack){
    state.selectedCell={row:nr,col:nc};
    if(dx!==0) state.direction='across';
    if(dy!==0) state.direction='down';
    document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
    document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
    highlightWord(); updateActiveClue();
  }
}

/* ‚ïê‚ïê‚ïê FIREBASE LISTENERS ‚ïê‚ïê‚ïê */
function listenRoom() {
  if (!state.roomRef) return;
  state.roomRef.child('cells').on('value', snap => {
    const cells=snap.val(); if(!cells) return;
    for (const k of Object.keys(cells)) {
      const [r,c]=k.split('_').map(Number);
      if (!state.grid[r]?.[c]) continue;
      if (state.mode==='collaborative') { state.grid[r][c].filled.shared=cells[k].letter||''; }
      else { const d=cells[k]; if(d.p1!==undefined) state.grid[r][c].filled.p1=d.p1; if(d.p2!==undefined) state.grid[r][c].filled.p2=d.p2; }
      updateCellDisplay(r,c);
    }
    checkCompletion();
  });
  const peer = state.playerId==='p1'?'p2':'p1';
  state.roomRef.child(`cursors/${peer}`).on('value', snap => {
    document.querySelectorAll('.peer-cursor').forEach(e=>e.classList.remove('peer-cursor'));
    const cur=snap.val(); if(cur){const el=getCellEl(cur.row,cur.col);if(el) el.classList.add('peer-cursor');}
  });
  state.roomRef.child('scores').on('value', snap => { const s=snap.val(); if(s) state.scores=s; });
}

/* ‚ïê‚ïê‚ïê COMPLETION ‚ïê‚ïê‚ïê */
function checkCompletion() {
  if (state.gameComplete) return;
  let done=0, total=0;
  for (const dir of ['across','down']) {
    for (const clue of state.clues[dir]) {
      total++;
      let word='';
      for (let i=0;i<clue.answer.length;i++) {
        const r=clue.dir==='across'?clue.row:clue.row+i;
        const c=clue.dir==='across'?clue.col+i:clue.col;
        word += state.mode==='competitive'?(state.grid[r][c].filled[state.playerId]||''):(state.grid[r][c].filled.shared||'');
      }
      const el=document.getElementById(`clue_${clue.dir}_${clue.number}`);
      if (word.toUpperCase()===clue.answer.toUpperCase()) { done++; if(el) el.classList.add('completed'); }
      else { if(el) el.classList.remove('completed'); }
    }
  }
  document.getElementById('hudScore').textContent = `${done}/${total}`;
  if (done===total) { state.gameComplete=true; clearInterval(state.timerInterval); clearSavedGame(); showWinScreen(); }
}

/* ‚ïê‚ïê‚ïê WIN ‚ïê‚ïê‚ïê */
function showWinScreen() {
  const elapsed=Math.floor((Date.now()-state.timerStart)/1000);
  const ts=`${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
  const tw = state.clues.across.length+state.clues.down.length;
  const puzzleTitle = state.puzzle.title||'Crossword';
  if (state.mode==='solo') {
    saveScore('crossword', puzzleTitle, state.playerName, elapsed, tw);
    document.getElementById('winTitle').textContent=`Nice work, ${state.playerName}!`;
    document.getElementById('winSubtitle').textContent=puzzleTitle;
    document.getElementById('winStats').innerHTML=`<div style="text-align:center"><div class="win-stat-val">${ts}</div><div class="win-stat-label">Time</div></div><div style="text-align:center"><div class="win-stat-val">${tw}</div><div class="win-stat-label">Words</div></div>`;
    document.getElementById('winScores').style.display='block';
    document.getElementById('winScores').innerHTML='<div style="text-align:center;color:var(--ink-faint);font-size:0.75rem;padding:8px">Loading rankings‚Ä¶</div>';
    getFirebaseRankings('crossword').then(rankings => {
      document.getElementById('winScores').innerHTML=`<div style="text-align:left;width:100%;max-width:320px;margin:0 auto"><div style="font-family:'DM Mono',monospace;font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;color:var(--gold-dim);margin-bottom:4px">üèÜ Ranking Pool</div>${buildRankingHTML(rankings,5)}</div>`;
    });
  } else if (state.mode==='collaborative') {
    document.getElementById('winTitle').textContent='You solved it together! ü§ùüèæ';
    document.getElementById('winSubtitle').textContent=puzzleTitle;
    document.getElementById('winStats').innerHTML=`<div style="text-align:center"><div class="win-stat-val">${ts}</div><div class="win-stat-label">Time</div></div><div style="text-align:center"><div class="win-stat-val">${tw}</div><div class="win-stat-label">Words</div></div>`;
    document.getElementById('winScores').style.display='none';
  } else {
    const p1=state.scores.p1||0, p2=state.scores.p2||0;
    const w=p1>p2?'Player 1':p2>p1?'Player 2':'Tie';
    document.getElementById('winTitle').textContent=w==='Tie'?"It's a tie!":`${w} wins!`;
    document.getElementById('winSubtitle').textContent=ts;
    document.getElementById('winScores').style.display='flex';
    document.getElementById('winScores').innerHTML=`<div style="text-align:center"><div class="win-stat-val">${p1}</div><div class="win-stat-label">P1</div></div><div style="text-align:center"><div class="win-stat-val">${p2}</div><div class="win-stat-label">P2</div></div>`;
  }
  triggerWinCelebration();
  showScreen('screenWin');
}

/* ‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê */
function updateTimer() {
  if (!state.timerStart) return;
  const e=Math.floor((Date.now()-state.timerStart)/1000);
  document.getElementById('hudTimer').textContent=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,'0')}`;
}

/* ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê */
function leaveRoom() {
  clearInterval(state.timerInterval);
  if (state.roomRef){state.roomRef.off();state.roomRef=null;}
  document.getElementById('clueDrawer').classList.remove('open');
  state.selectedCell=null; state.gameComplete=false; state.puzzle=null;
  showScreen('screenLobby');
}
function backToLobby() { leaveRoom(); }

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
(function(){
  const p=new URLSearchParams(location.search);
  const room=p.get('room');
  if (room) {
    document.getElementById('inputRoom').value=room.toUpperCase();
    setMode('collaborative', document.querySelectorAll('.mode-btn')[1]);
    // Auto-focus the join input so it's obvious
    setTimeout(()=>document.getElementById('inputRoom').focus(), 300);
  }
})();

document.addEventListener('touchstart', e => {
  if (e.target.closest('.grid-cell')) e.preventDefault();
}, {passive:false});

// OSK: use touchend + click for maximum compatibility
function handleOSKPress(e) {
  const btn = e.target.closest('.osk-key');
  if (!btn) return;
  e.preventDefault();
  const key = btn.dataset.key;
  if (key==='BACKSPACE') { handleBackspace(); return; }
  if (key==='TOGGLE') {
    state.direction=state.direction==='across'?'down':'across';
    document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
    document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
    if (state.selectedCell) { highlightWord(); updateActiveClue(); }
    return;
  }
  if (/^[A-Z]$/.test(key)) typeLetter(key);
}
document.getElementById('osk').addEventListener('touchend', handleOSKPress);
document.getElementById('osk').addEventListener('click', handleOSKPress);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/*  WORD SEARCH ENGINE                             */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const WS_THEMES = [
  { name: "üèõÔ∏è Washington DC", words: ["MONUMENT","CAPITOL","MALL","DUPONT","FOGGY","ANACOSTIA","POTOMAC","WHARF","ADAMS","SHAW"] },
  { name: "ü¶Ä Baltimore", words: ["HARBOR","CAMDEN","FELLS","HOMEWOOD","DRUID","HAMPDEN","FEDERAL","CANTON","PIGTOWN","LOCUST"] },
  { name: "üîî Philadelphia", words: ["LIBERTY","RITTENHOUSE","FISHTOWN","BROAD","MANAYUNK","TEMPLE","MARKET","ROCKY","LOGAN","WISTER"] },
  { name: "ü§† Austin", words: ["CONGRESS","ZILKER","BARTON","LAMAR","MANOR","DOMAIN","RAINEY","MUELLER","BOULDIN","SIXTH"] },
  { name: "üé∑ Harlem", words: ["APOLLO","LENOX","STRIVERS","MORNINGSIDE","MARCUS","SYLVIA","RUCKER","SCHOMBURG","MALCOLM","CONVENT"] },
  { name: "üá≤üáΩ CDMX", words: ["ZOCALO","REFORMA","CONDESA","POLANCO","COYOACAN","CHAPULTEPEC","FRIDA","ROMA","XOCHIMILCO","ALAMEDA"] },
  { name: "üêæ Animals", words: ["TIGER","EAGLE","WHALE","HORSE","SNAKE","DOLPHIN","RABBIT","FALCON","PANDA","SHARK"] },
  { name: "üçï Food & Drink", words: ["PASTA","MANGO","BREAD","JUICE","SALAD","CHEESE","COFFEE","PEPPER","OLIVE","STEAK"] },
  { name: "üéµ Music", words: ["PIANO","DRUMS","BLUES","GUITAR","MELODY","RHYTHM","SINGER","CHORUS","TEMPO","VINYL"] },
  { name: "‚öΩ Sports", words: ["SOCCER","TENNIS","RUGBY","BOXING","SPRINT","HOCKEY","DIVING","GOLF","RELAY","TRACK"] },
  { name: "üåø Nature", words: ["RIVER","OCEAN","STORM","FOREST","MEADOW","CANYON","SUNSET","BREEZE","CORAL","BLOOM"] },
  { name: "üî¨ Science", words: ["ATOMS","ORBIT","SOLAR","LIGHT","GRAVITY","ENERGY","PLASMA","GENOME","QUARK","LASER"] },
];

// Populate theme selector
(function populateWSThemes(){
  const sel = document.getElementById('wsThemeSelect');
  if (!sel) return;
  WS_THEMES.forEach((t,i) => {
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = t.name;
    sel.appendChild(opt);
  });
})();

const ws = {
  grid: [], words: [], placed: [], found: new Set(),
  rows: 10, cols: 10, cellSize: 0,
  canvas: null, ctx: null,
  dragging: false, dragStart: null, dragEnd: null,
  timerStart: null, timerInterval: null,
  theme: null, foundLines: [],
};

const WS_DIRS = [
  {dr:0,dc:1},{dr:1,dc:0},{dr:1,dc:1},{dr:-1,dc:1},
  {dr:0,dc:-1},{dr:-1,dc:0},{dr:-1,dc:-1},{dr:1,dc:-1}
];

function generateWordSearch(words, rows, cols) {
  const grid = Array.from({length:rows}, ()=> Array(cols).fill(''));
  const placed = [];
  // Shuffle words, try longest first
  const sorted = [...words].sort((a,b)=>b.length-a.length);
  for (const word of sorted) {
    let didPlace = false;
    const dirs = [...WS_DIRS].sort(()=>Math.random()-0.5);
    const attempts = 80;
    for (let a=0;a<attempts&&!didPlace;a++) {
      const dir = dirs[a%dirs.length];
      const maxR = rows - (dir.dr>0? word.length-1 : dir.dr<0? -(word.length-1) : 0);
      const maxC = cols - (dir.dc>0? word.length-1 : dir.dc<0? -(word.length-1) : 0);
      const minR = dir.dr<0? word.length-1 : 0;
      const minC = dir.dc<0? word.length-1 : 0;
      if (minR>=maxR || minC>=maxC) continue;
      const r = minR + Math.floor(Math.random()*(maxR-minR));
      const c = minC + Math.floor(Math.random()*(maxC-minC));
      let ok = true;
      for (let i=0;i<word.length;i++) {
        const nr=r+dir.dr*i, nc=c+dir.dc*i;
        if (nr<0||nr>=rows||nc<0||nc>=cols) {ok=false;break;}
        const existing = grid[nr][nc];
        if (existing && existing !== word[i]) {ok=false;break;}
      }
      if (ok) {
        for (let i=0;i<word.length;i++) grid[r+dir.dr*i][c+dir.dc*i]=word[i];
        placed.push({word, row:r, col:c, dr:dir.dr, dc:dir.dc});
        didPlace = true;
      }
    }
  }
  // Fill blanks
  const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  for (let r=0;r<rows;r++) for (let c=0;c<cols;c++) {
    if (!grid[r][c]) grid[r][c]=alpha[Math.floor(Math.random()*26)];
  }
  return {grid, placed};
}

function setGameType(type, el) {
  const row = el.parentElement;
  row.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  state.gameType = type;
  document.getElementById('cwLobbyOptions').style.display = type==='crossword'?'':'none';
  document.getElementById('wsLobbyOptions').style.display = type==='wordsearch'?'':'none';
}

function startWordSearch() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { document.getElementById('inputName').focus(); return; }
  state.playerName = name;

  const sel = document.getElementById('wsThemeSelect');
  let theme;
  if (sel.value === 'random') {
    theme = WS_THEMES[Math.floor(Math.random()*WS_THEMES.length)];
  } else {
    theme = WS_THEMES[parseInt(sel.value)];
  }
  ws.theme = theme;
  ws.words = theme.words.map(w=>w.toUpperCase());
  ws.found = new Set();
  ws.foundLines = [];
  // Dynamic grid size: need at least max-word-length, min 10
  const maxLen = Math.max(...ws.words.map(w=>w.length));
  const gridSize = Math.max(10, maxLen + 2);
  ws.rows = gridSize; ws.cols = gridSize;

  const result = generateWordSearch(ws.words, ws.rows, ws.cols);
  ws.grid = result.grid;
  ws.placed = result.placed;

  // Build word bank
  const bank = document.getElementById('wsWordBank');
  bank.innerHTML = '';
  ws.words.forEach(w => {
    const isPlaced = ws.placed.some(p=>p.word===w);
    if (!isPlaced) return; // Skip words that couldn't fit
    const span = document.createElement('span');
    span.className = 'ws-word'; span.id = 'wsw_'+w;
    span.textContent = w;
    bank.appendChild(span);
  });

  document.getElementById('wsHudTitle').textContent = theme.name + (state.ranked ? ' üèÜ' : '');
  const totalWords = ws.placed.length;
  document.getElementById('wsHudScore').textContent = `0/${totalWords}`;

  ws.timerStart = Date.now();
  clearInterval(ws.timerInterval);
  ws.timerInterval = setInterval(()=>{
    const s=Math.floor((Date.now()-ws.timerStart)/1000);
    document.getElementById('wsHudTimer').textContent=`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
  }, 1000);

  showScreen('screenWordSearch');
  requestAnimationFrame(initWSCanvas);
}

function initWSCanvas() {
  const wrapper = document.getElementById('wsGridWrapper');
  const canvas = document.getElementById('wsCanvas');
  ws.canvas = canvas; ws.ctx = canvas.getContext('2d');

  const aW = wrapper.clientWidth - 16;
  const aH = wrapper.clientHeight - 16;
  const cs = Math.min(Math.floor(aW/ws.cols), Math.floor(aH/ws.rows), 48);
  ws.cellSize = cs;

  const dpr = window.devicePixelRatio || 1;
  canvas.width = (cs * ws.cols) * dpr;
  canvas.height = (cs * ws.rows) * dpr;
  canvas.style.width = (cs * ws.cols) + 'px';
  canvas.style.height = (cs * ws.rows) + 'px';
  ws.ctx.setTransform(dpr,0,0,dpr,0,0);

  drawWSGrid();
  // Touch/mouse listeners
  canvas.onpointerdown = wsPointerDown;
  canvas.onpointermove = wsPointerMove;
  canvas.onpointerup = wsPointerUp;
  canvas.onpointercancel = wsPointerUp;
}

function wsGridCoord(e) {
  const rect = ws.canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const c = Math.floor(x / ws.cellSize);
  const r = Math.floor(y / ws.cellSize);
  return {r: Math.max(0,Math.min(r,ws.rows-1)), c: Math.max(0,Math.min(c,ws.cols-1))};
}

function wsPointerDown(e) {
  e.preventDefault();
  ws.canvas.setPointerCapture(e.pointerId);
  ws.dragging = true;
  ws.dragStart = wsGridCoord(e);
  ws.dragEnd = ws.dragStart;
  drawWSGrid();
}

function wsPointerMove(e) {
  if (!ws.dragging) return;
  e.preventDefault();
  const coord = wsGridCoord(e);
  // Snap to valid line (horizontal, vertical, or diagonal)
  const dr = coord.r - ws.dragStart.r;
  const dc = coord.c - ws.dragStart.c;
  const absDr = Math.abs(dr), absDc = Math.abs(dc);
  let snapR = ws.dragStart.r, snapC = ws.dragStart.c;
  if (absDr <= 1 && absDc <= 1) {
    snapR = coord.r; snapC = coord.c;
  } else if (absDc === 0) {
    snapR = coord.r; snapC = ws.dragStart.c;
  } else if (absDr === 0) {
    snapR = ws.dragStart.r; snapC = coord.c;
  } else if (Math.abs(absDr-absDc) <= 1) {
    const dist = Math.max(absDr, absDc);
    snapR = ws.dragStart.r + Math.sign(dr)*dist;
    snapC = ws.dragStart.c + Math.sign(dc)*dist;
  } else if (absDr > absDc) {
    const dist = absDr;
    snapR = ws.dragStart.r + Math.sign(dr)*dist;
    snapC = ws.dragStart.c;
  } else {
    const dist = absDc;
    snapR = ws.dragStart.r;
    snapC = ws.dragStart.c + Math.sign(dc)*dist;
  }
  snapR = Math.max(0,Math.min(snapR,ws.rows-1));
  snapC = Math.max(0,Math.min(snapC,ws.cols-1));
  ws.dragEnd = {r:snapR, c:snapC};
  drawWSGrid();
}

function wsPointerUp(e) {
  if (!ws.dragging) return;
  ws.dragging = false;
  // Check if selection matches a word
  if (ws.dragStart && ws.dragEnd) {
    const sr=ws.dragStart.r, sc=ws.dragStart.c, er=ws.dragEnd.r, ec=ws.dragEnd.c;
    const dr = er===sr ? 0 : (er>sr?1:-1);
    const dc = ec===sc ? 0 : (ec>sc?1:-1);
    const len = Math.max(Math.abs(er-sr), Math.abs(ec-sc))+1;
    let selected = '';
    for (let i=0;i<len;i++) selected += ws.grid[sr+dr*i][sc+dc*i];

    // Check forward and reverse
    for (const p of ws.placed) {
      if (ws.found.has(p.word)) continue;
      if (p.word === selected || p.word === selected.split('').reverse().join('')) {
        ws.found.add(p.word);
        ws.foundLines.push({r1:sr,c1:sc,r2:er,c2:ec});
        const el = document.getElementById('wsw_'+p.word);
        if (el) el.classList.add('found');
        document.getElementById('wsHudScore').textContent = `${ws.found.size}/${ws.placed.length}`;
        if (ws.found.size === ws.placed.length) {
          clearInterval(ws.timerInterval);
          setTimeout(showWSWin, 400);
        }
        break;
      }
    }
  }
  ws.dragStart = null; ws.dragEnd = null;
  drawWSGrid();
}

function drawWSGrid() {
  const ctx = ws.ctx;
  const cs = ws.cellSize;
  const w = cs*ws.cols, h = cs*ws.rows;
  // Background
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,w,h);

  // Grid lines
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 0.5;
  for (let r=0;r<=ws.rows;r++) {
    ctx.beginPath(); ctx.moveTo(0,r*cs); ctx.lineTo(w,r*cs); ctx.stroke();
  }
  for (let c=0;c<=ws.cols;c++) {
    ctx.beginPath(); ctx.moveTo(c*cs,0); ctx.lineTo(c*cs,h); ctx.stroke();
  }

  // Found word highlights
  for (const line of ws.foundLines) {
    drawWSLine(line.r1, line.c1, line.r2, line.c2, 'rgba(74,124,94,0.25)', cs*0.7);
  }

  // Active drag highlight
  if (ws.dragging && ws.dragStart && ws.dragEnd) {
    drawWSLine(ws.dragStart.r, ws.dragStart.c, ws.dragEnd.r, ws.dragEnd.c, 'rgba(107,163,214,0.35)', cs*0.7);
  }

  // Letters
  ctx.fillStyle = '#1a1208';
  ctx.font = `700 ${cs*0.48}px 'DM Sans', sans-serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  for (let r=0;r<ws.rows;r++) {
    for (let c=0;c<ws.cols;c++) {
      ctx.fillText(ws.grid[r][c], c*cs+cs/2, r*cs+cs/2+1);
    }
  }

  // Border
  ctx.strokeStyle = '#1a1208';
  ctx.lineWidth = 2;
  ctx.strokeRect(0,0,w,h);
}

function drawWSLine(r1,c1,r2,c2,color,width) {
  const ctx = ws.ctx;
  const cs = ws.cellSize;
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = width;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(c1*cs+cs/2, r1*cs+cs/2);
  ctx.lineTo(c2*cs+cs/2, r2*cs+cs/2);
  ctx.stroke();
  ctx.restore();
}

function showWSWin() {
  const elapsed=Math.floor((Date.now()-ws.timerStart)/1000);
  const ts=`${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
  const themeName = ws.theme?.name||'Word Search';
  saveScore('wordsearch', themeName, state.playerName, elapsed, ws.placed.length);
  document.getElementById('winTitle').textContent=`Nice work, ${state.playerName}!`;
  document.getElementById('winSubtitle').textContent=themeName;
  document.getElementById('winStats').innerHTML=`<div style="text-align:center"><div class="win-stat-val">${ts}</div><div class="win-stat-label">Time</div></div><div style="text-align:center"><div class="win-stat-val">${ws.placed.length}</div><div class="win-stat-label">Words</div></div>`;
  if (state.ranked) {
    document.getElementById('winScores').style.display='block';
    document.getElementById('winScores').innerHTML='<div style="text-align:center;color:var(--ink-faint);font-size:0.75rem;padding:8px">Loading rankings‚Ä¶</div>';
    getFirebaseRankings('wordsearch').then(rankings => {
      // Find player's rank
      const rank = rankings.findIndex(r => r.player === state.playerName && r.time === elapsed) + 1;
      let rankMsg = '';
      if (rank === 1) rankMsg = '<div style="text-align:center;font-size:1.1rem;font-weight:700;color:var(--gold-dim);margin-bottom:6px">üëë NEW #1 ‚Äî YOU\'RE ON TOP!</div>';
      else if (rank > 0 && rank <= 3) rankMsg = `<div style="text-align:center;font-size:0.9rem;font-weight:600;color:var(--gold-dim);margin-bottom:6px">üî• You placed #${rank}!</div>`;
      else if (rank > 0) rankMsg = `<div style="text-align:center;font-size:0.8rem;color:var(--ink-faint);margin-bottom:6px">You placed #${rank}</div>`;
      document.getElementById('winScores').innerHTML=`<div style="text-align:left;width:100%;max-width:320px;margin:0 auto">${rankMsg}<div style="font-family:'DM Mono',monospace;font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;color:var(--gold-dim);margin-bottom:4px">üèÜ Ranking Pool</div>${buildRankingHTML(rankings,5)}</div>`;
    });
  } else {
    document.getElementById('winScores').style.display='none';
  }
  triggerWinCelebration();
  showScreen('screenWin');
}

function exitWordSearch() {
  clearInterval(ws.timerInterval);
  showScreen('screenLobby');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/*  RANKING POOL ‚Äî Firebase Leaderboard             */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function saveScore(gameType, puzzleTitle, playerName, timeSeconds, wordCount) {
  // Always save locally
  try {
    const key = 'mwv_rankings';
    const raw = localStorage.getItem(key);
    const rankings = raw ? JSON.parse(raw) : [];
    rankings.push({
      gameType, puzzle: puzzleTitle, player: playerName,
      time: timeSeconds, words: wordCount,
      date: new Date().toISOString().split('T')[0]
    });
    rankings.sort((a,b) => a.time - b.time);
    if (rankings.length > 50) rankings.length = 50;
    localStorage.setItem(key, JSON.stringify(rankings));
  } catch(e) {}

  // If ranked, also save to Firebase
  if (state.ranked) {
    try {
      db.ref('rankings').push({
        gameType, puzzle: puzzleTitle, player: playerName,
        time: timeSeconds, words: wordCount,
        date: new Date().toISOString().split('T')[0],
        ts: firebase.database.ServerValue.TIMESTAMP
      });
    } catch(e) { console.log('Firebase ranking save failed:', e); }
  }
}

async function getFirebaseRankings(gameType) {
  try {
    const snap = await db.ref('rankings')
      .orderByChild('time')
      .limitToFirst(20)
      .once('value');
    const results = [];
    snap.forEach(c => {
      const r = c.val();
      if (!gameType || r.gameType === gameType) results.push(r);
    });
    return results.sort((a,b) => a.time - b.time);
  } catch(e) { return []; }
}

function getLocalRankings(gameType) {
  try {
    const raw = localStorage.getItem('mwv_rankings');
    if (!raw) return [];
    return JSON.parse(raw).filter(r => !gameType || r.gameType === gameType).sort((a,b) => a.time - b.time);
  } catch(e) { return []; }
}

function buildRankingHTML(rankings, limit) {
  if (!rankings.length) return '<div style="color:var(--ink-faint);font-size:0.75rem;text-align:center;padding:8px">No scores yet ‚Äî be the first!</div>';
  const top = rankings.slice(0, limit || 5);
  const medals = ['ü•á','ü•à','ü•â'];
  let html = '<div style="display:flex;flex-direction:column;gap:4px;margin-top:8px">';
  top.forEach((r, i) => {
    const ts = `${Math.floor(r.time/60)}:${(r.time%60).toString().padStart(2,'0')}`;
    const medal = medals[i] || `#${i+1}`;
    html += `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--paper-warm);border-radius:6px">`;
    html += `<span style="font-size:0.9rem;width:24px;text-align:center">${medal}</span>`;
    html += `<span style="flex:1;font-size:0.8rem;font-weight:600">${r.player}</span>`;
    html += `<span style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--gold-dim)">${ts}</span>`;
    html += `<span style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--ink-faint)">${r.date||''}</span>`;
    html += `</div>`;
  });
  html += '</div>';
  return html;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/*  WIN CELEBRATION ‚Äî Confetti + Effects             */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function triggerWinCelebration() {
  // Flash the screen gold briefly
  const flash = document.createElement('div');
  flash.style.cssText = 'position:fixed;inset:0;background:var(--gold-light);z-index:998;pointer-events:none;opacity:0.7;transition:opacity 0.5s';
  document.body.appendChild(flash);
  requestAnimationFrame(() => { flash.style.opacity = '0'; });
  setTimeout(() => flash.remove(), 600);

  // Animate ornament
  const orn = document.getElementById('winOrnament');
  orn.style.animation = 'none';
  void orn.offsetWidth;
  orn.style.animation = 'trophy-bounce 0.6s ease-out, trophy-glow 2s ease-in-out infinite 0.6s';
  
  // Launch confetti ‚Äî two waves
  const canvas = document.getElementById('confettiCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  
  const colors = ['#C4943E','#8B6914','#A67C2E','#D4A74A','#6B8F71','#4A7050','#E8D5B7','#B85450','#5B8CB8','#9B6FA8','#FFD700','#FF6347'];
  const confetti = [];
  
  // Wave 1: burst from center
  for (let i = 0; i < 80; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 3 + Math.random() * 6;
    confetti.push({
      x: canvas.width / 2, y: canvas.height * 0.3,
      w: 4 + Math.random() * 6, h: 8 + Math.random() * 12,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed - 3,
      rotation: Math.random() * 360,
      rotSpeed: (Math.random() - 0.5) * 15,
      wobble: Math.random() * Math.PI * 2,
      wobbleSpeed: 0.03 + Math.random() * 0.05,
    });
  }
  // Wave 2: rain from top
  for (let i = 0; i < 60; i++) {
    confetti.push({
      x: Math.random() * canvas.width, y: -20 - Math.random() * 300,
      w: 4 + Math.random() * 6, h: 8 + Math.random() * 12,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: (Math.random() - 0.5) * 3, vy: 2 + Math.random() * 3,
      rotation: Math.random() * 360,
      rotSpeed: (Math.random() - 0.5) * 12,
      wobble: Math.random() * Math.PI * 2,
      wobbleSpeed: 0.03 + Math.random() * 0.05,
    });
  }
  
  let frame = 0;
  const maxFrames = 240; // ~4 seconds at 60fps
  
  function drawConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const alpha = frame > maxFrames - 50 ? (maxFrames - frame) / 50 : 1;
    ctx.globalAlpha = alpha;
    
    for (const p of confetti) {
      p.x += p.vx + Math.sin(p.wobble) * 0.5;
      p.y += p.vy;
      p.vy += 0.06; // gravity
      p.vx *= 0.99; // air resistance
      p.rotation += p.rotSpeed;
      p.wobble += p.wobbleSpeed;
      
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rotation * Math.PI / 180);
      
      // Mix of rectangles and circles
      ctx.fillStyle = p.color;
      if (p.w > 6) {
        ctx.beginPath();
        ctx.arc(0, 0, p.w / 2, 0, Math.PI * 2);
        ctx.fill();
      } else {
        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      }
      ctx.restore();
    }
    
    ctx.globalAlpha = 1;
    frame++;
    if (frame < maxFrames) {
      requestAnimationFrame(drawConfetti);
    } else {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  }
  
  requestAnimationFrame(drawConfetti);
  
  // Title reveal animation
  const title = document.getElementById('winTitle');
  title.style.animation = 'none';
  void title.offsetWidth;
  title.style.animation = 'win-reveal 0.8s ease-out';
}

// Save state when page loses focus (user switches apps on mobile)
document.addEventListener('visibilitychange', () => { if (document.hidden) saveGameState(); });
window.addEventListener('beforeunload', () => saveGameState());

// Check for saved game on page load ‚Äî show Resume button
(function checkSavedGame(){
  try {
    const raw = localStorage.getItem('mwv_save');
    if (!raw) return;
    const data = JSON.parse(raw);
    if (!data.puzzle || !data.filledCells) return;
    const container = document.createElement('div');
    container.id = 'resumeContainer';
    container.style.cssText = 'margin-top:8px;display:flex;gap:6px';
    const btn = document.createElement('button');
    btn.className = 'btn-primary';
    btn.style.cssText = 'flex:1;margin:0;background:var(--sage);color:#fff';
    btn.textContent = '\u21a9 Resume: ' + (data.puzzle.title||'Puzzle');
    btn.onclick = () => { restoreGameState(); };
    const clearBtn = document.createElement('button');
    clearBtn.className = 'btn-outline-sm';
    clearBtn.style.cssText = 'flex-shrink:0;padding:8px 12px;font-size:0.75rem';
    clearBtn.textContent = '‚úï';
    clearBtn.title = 'Discard saved game';
    clearBtn.onclick = () => { clearSavedGame(); container.remove(); };
    container.appendChild(btn);
    container.appendChild(clearBtn);
    const playBtn = document.getElementById('btnPlay');
    playBtn.parentNode.insertBefore(container, playBtn.nextSibling);
  } catch(e){}
})();
</script>
</body>
</html>
