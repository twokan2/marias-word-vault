<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Maria's Word Vault</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;1,400;1,600&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/*  MARIA'S WORD VAULT â€” Design System        */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --ink: #1a1208;
  --ink-soft: #3d3224;
  --ink-faint: #6b5d4f;
  --paper: #faf7f2;
  --paper-warm: #f5f0e8;
  --paper-dim: #ebe5d9;
  --gold: #c9943a;
  --gold-light: #e8c97a;
  --gold-dim: #8a6420;
  --rust: #b84c2a;
  --sage: #4a7c5e;
  --sage-light: #d4e8dc;
  --blue-select: #a8c8e8;
  --blue-active: #6ba3d6;
  --cell-size: 40px;
  --grid-gap: 0px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%; width: 100%;
  overflow: hidden;
  font-family: 'DM Sans', sans-serif;
  background: var(--paper);
  color: var(--ink);
  -webkit-tap-highlight-color: transparent;
  -webkit-text-size-adjust: 100%;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}

/* â•â•â•â•â•â•â•â•â•â•â• TYPOGRAPHY â•â•â•â•â•â•â•â•â•â•â• */
.font-display { font-family: 'Playfair Display', Georgia, serif; }
.font-mono { font-family: 'DM Mono', monospace; }

/* â•â•â•â•â•â•â•â•â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â•â• */
.screen {
  display: none;
  position: fixed; inset: 0;
  flex-direction: column;
  align-items: center;
  overflow-y: auto;
  background: var(--paper);
}
.screen.active { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â• */
#screenLobby {
  justify-content: center;
  padding: 24px;
  gap: 0;
}

.lobby-masthead {
  text-align: center;
  margin-bottom: 32px;
}

.lobby-rule {
  width: 60px; height: 2px;
  background: var(--gold);
  margin: 0 auto 12px;
}

.lobby-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(1.8rem, 6vw, 2.6rem);
  font-weight: 800;
  color: var(--ink);
  letter-spacing: -0.5px;
  line-height: 1.1;
}

.lobby-subtitle {
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  color: var(--ink-faint);
  letter-spacing: 3px;
  text-transform: uppercase;
  margin-top: 8px;
}

.lobby-form {
  width: 100%; max-width: 340px;
  display: flex; flex-direction: column;
  gap: 12px;
}

.form-label {
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  color: var(--ink-faint);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: -6px;
  margin-top: 8px;
}

.form-input {
  font-family: 'DM Sans', sans-serif;
  font-size: 1rem; font-weight: 600;
  padding: 12px 16px;
  border: 2px solid var(--paper-dim);
  border-radius: 2px;
  background: white;
  color: var(--ink);
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
.form-input:focus { border-color: var(--gold); }
.form-input::placeholder { color: #bbb; font-weight: 400; }

.mode-picker {
  display: flex; gap: 6px;
  width: 100%;
}
.mode-btn {
  flex: 1;
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem;
  font-weight: 500;
  letter-spacing: 0.5px;
  padding: 10px 6px;
  border: 2px solid var(--paper-dim);
  border-radius: 2px;
  background: white;
  color: var(--ink-faint);
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
}
.mode-btn.selected {
  border-color: var(--gold);
  color: var(--ink);
  background: var(--paper-warm);
  box-shadow: 0 2px 0 var(--gold-dim);
}

.puzzle-picker {
  display: flex; gap: 6px; width: 100%;
}
.puzzle-btn {
  flex: 1;
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem; font-weight: 500;
  padding: 10px 6px;
  border: 2px solid var(--paper-dim);
  border-radius: 2px;
  background: white; color: var(--ink-faint);
  cursor: pointer; text-align: center;
  transition: all 0.15s;
}
.puzzle-btn.selected {
  border-color: var(--sage);
  color: var(--ink);
  background: var(--sage-light);
}

.room-row {
  display: flex; gap: 8px; width: 100%;
}
.room-row .form-input { flex: 1; text-transform: uppercase; letter-spacing: 3px; font-family: 'DM Mono', monospace; }

.btn-primary {
  font-family: 'Playfair Display', serif;
  font-size: 1rem; font-weight: 700;
  padding: 14px 24px;
  border: none; border-radius: 2px;
  cursor: pointer;
  transition: all 0.12s;
  width: 100%;
  letter-spacing: 0.5px;
}
.btn-gold {
  background: var(--gold);
  color: white;
  box-shadow: 0 2px 0 var(--gold-dim);
}
.btn-gold:active { transform: translateY(2px); box-shadow: none; }

.btn-rust {
  background: var(--rust);
  color: white;
  box-shadow: 0 2px 0 #8a3318;
}
.btn-rust:active { transform: translateY(2px); box-shadow: none; }

.btn-sage {
  background: var(--sage);
  color: white;
  box-shadow: 0 2px 0 #375e46;
}
.btn-sage:active { transform: translateY(2px); box-shadow: none; }

.btn-outline {
  background: transparent;
  color: var(--ink-faint);
  border: 2px solid var(--paper-dim);
  box-shadow: none;
  font-size: 0.85rem;
}

.lobby-actions {
  display: flex; flex-direction: column;
  gap: 8px; width: 100%;
  margin-top: 8px;
}

.lobby-divider {
  display: flex; align-items: center; gap: 12px;
  width: 100%; margin: 4px 0;
}
.lobby-divider::before, .lobby-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--paper-dim);
}
.lobby-divider span {
  font-family: 'DM Mono', monospace;
  font-size: 0.65rem; color: #ccc;
  letter-spacing: 2px; text-transform: uppercase;
}

.custom-puzzle-select {
  width: 100%;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  padding: 10px 14px;
  border: 2px solid var(--paper-dim);
  border-radius: 2px;
  background: white;
  color: var(--ink);
  outline: none;
}

/* â•â•â•â•â•â•â•â•â•â•â• WAITING ROOM â•â•â•â•â•â•â•â•â•â•â• */
#screenWaiting {
  justify-content: center;
  gap: 20px;
  padding: 24px;
}

.waiting-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.4rem;
  font-weight: 700;
}

.room-code-box {
  font-family: 'DM Mono', monospace;
  font-size: 2rem;
  letter-spacing: 8px;
  color: var(--gold);
  background: white;
  padding: 12px 28px;
  border: 2px solid var(--paper-dim);
  border-radius: 2px;
}

.share-url {
  font-family: 'DM Mono', monospace;
  font-size: 0.65rem;
  color: var(--ink-faint);
  word-break: break-all;
  text-align: center;
  max-width: 300px;
  cursor: pointer;
}
.share-url:hover { color: var(--gold); }

.player-slots {
  display: flex; flex-direction: column;
  gap: 8px; width: 100%; max-width: 280px;
}

.player-slot {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px;
  border: 2px solid var(--paper-dim);
  border-radius: 2px;
  background: white;
  font-weight: 600;
  font-size: 0.9rem;
}
.player-slot.connected { border-color: var(--sage); }
.player-slot .dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--paper-dim);
}
.player-slot.connected .dot { background: var(--sage); }

.waiting-spinner {
  width: 24px; height: 24px;
  border: 3px solid var(--paper-dim);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â• */
#screenGame {
  padding: 0;
  overflow: hidden;
}

.game-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--ink);
  color: var(--paper);
  width: 100%;
  min-height: 44px;
  flex-shrink: 0;
  z-index: 10;
}

.game-header-left {
  display: flex; align-items: center; gap: 8px;
}
.game-back-btn {
  background: none; border: none;
  color: var(--paper); font-size: 1.1rem;
  cursor: pointer; padding: 4px;
  opacity: 0.7;
}
.game-back-btn:hover { opacity: 1; }

.game-title-sm {
  font-family: 'Playfair Display', serif;
  font-size: 0.85rem;
  font-weight: 700;
  opacity: 0.9;
}

.game-header-right {
  display: flex; align-items: center; gap: 12px;
}

.hud-badge {
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  background: rgba(255,255,255,0.1);
  padding: 3px 10px;
  border-radius: 2px;
  display: flex; align-items: center; gap: 4px;
}
.hud-badge .val { color: var(--gold-light); font-weight: 600; }

/* Clue bar below header */
.clue-bar {
  width: 100%;
  padding: 10px 14px;
  background: white;
  border-bottom: 1px solid var(--paper-dim);
  display: flex;
  align-items: flex-start;
  gap: 10px;
  min-height: 48px;
  flex-shrink: 0;
  z-index: 5;
  cursor: pointer;
}

.clue-number {
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--gold-dim);
  flex-shrink: 0;
  padding-top: 2px;
  min-width: 50px;
}

.clue-text {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.92rem;
  font-weight: 500;
  color: var(--ink);
  line-height: 1.35;
  flex: 1;
}

/* Grid wrapper â€” takes remaining space */
.grid-wrapper {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  padding: 8px;
  position: relative;
  width: 100%;
}

.crossword-grid {
  display: grid;
  gap: var(--grid-gap);
  position: relative;
  border: 2px solid var(--ink);
}

.grid-cell {
  width: var(--cell-size);
  height: var(--cell-size);
  position: relative;
  background: white;
  border: 0.5px solid #ccc;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}

.grid-cell.black {
  background: var(--ink);
  cursor: default;
  border-color: var(--ink);
}

.grid-cell .cell-number {
  position: absolute;
  top: 1px; left: 2px;
  font-family: 'DM Sans', sans-serif;
  font-size: calc(var(--cell-size) * 0.24);
  font-weight: 700;
  color: var(--ink);
  line-height: 1;
  pointer-events: none;
}

.grid-cell .cell-letter {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'DM Sans', sans-serif;
  font-size: calc(var(--cell-size) * 0.52);
  font-weight: 700;
  color: var(--ink);
  pointer-events: none;
  text-transform: uppercase;
}

/* Selection states â€” NYT style */
.grid-cell.word-highlight {
  background: var(--blue-select);
}

.grid-cell.selected {
  background: var(--blue-active);
}

/* Peer cursor */
.grid-cell.peer-cursor {
  box-shadow: inset 0 0 0 2px var(--ink);
}

/* Correct / incorrect feedback */
.grid-cell.correct-flash {
  animation: correctPulse 0.4s ease;
}
@keyframes correctPulse {
  0% { background: var(--sage-light); }
  100% { background: white; }
}

.grid-cell.incorrect-flash .cell-letter {
  color: var(--rust);
}

/* Clue panel (bottom drawer) */
.clue-drawer {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: white;
  border-top: 2px solid var(--paper-dim);
  transform: translateY(100%);
  transition: transform 0.3s ease;
  z-index: 20;
  max-height: 55vh;
  overflow-y: auto;
}
.clue-drawer.open { transform: translateY(0); }

.clue-drawer-handle {
  width: 100%;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  position: sticky;
  top: 0;
  background: white;
  z-index: 1;
  border-bottom: 1px solid var(--paper-dim);
}
.clue-drawer-handle::after {
  content: '';
  display: inline-block;
  width: 36px; height: 4px;
  background: var(--paper-dim);
  border-radius: 2px;
}

.clue-section {
  padding: 8px 14px 14px;
}

.clue-section-title {
  font-family: 'DM Mono', monospace;
  font-size: 0.65rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--ink-faint);
  padding: 6px 0;
  border-bottom: 1px solid var(--paper-dim);
  margin-bottom: 4px;
}

.clue-item {
  display: flex; gap: 8px;
  padding: 7px 0;
  cursor: pointer;
  border-bottom: 1px solid rgba(0,0,0,0.04);
}
.clue-item:hover { background: var(--paper-warm); margin: 0 -14px; padding: 7px 14px; }
.clue-item.completed .clue-item-text { color: var(--ink-faint); text-decoration: line-through; }

.clue-item-num {
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--gold-dim);
  min-width: 28px;
  flex-shrink: 0;
}

.clue-item-text {
  font-size: 0.85rem;
  color: var(--ink);
  line-height: 1.35;
}

/* Keyboard bar (for toggling direction) */
.keyboard-bar {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 6px 12px;
  background: var(--paper-warm);
  border-top: 1px solid var(--paper-dim);
  flex-shrink: 0;
  gap: 8px;
  z-index: 5;
}

.kb-btn {
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  padding: 6px 14px;
  border: 1px solid var(--paper-dim);
  border-radius: 2px;
  background: white;
  color: var(--ink-faint);
  cursor: pointer;
}
.kb-btn.active { border-color: var(--gold); color: var(--ink); background: var(--paper); }

.kb-btn-icon {
  font-size: 1rem;
  padding: 6px 10px;
  border: 1px solid var(--paper-dim);
  border-radius: 2px;
  background: white;
  color: var(--ink-faint);
  cursor: pointer;
}

/* â•â•â•â•â•â•â•â•â•â•â• WIN SCREEN â•â•â•â•â•â•â•â•â•â•â• */
#screenWin {
  justify-content: center;
  gap: 16px;
  padding: 32px;
}

.win-ornament {
  font-size: 2.4rem;
}

.win-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(1.6rem, 5vw, 2.2rem);
  font-weight: 800;
  text-align: center;
}

.win-subtitle {
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  color: var(--ink-faint);
  letter-spacing: 1px;
}

.win-stats {
  display: flex; gap: 24px;
  margin: 8px 0;
}

.win-stat {
  text-align: center;
}
.win-stat-val {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--gold);
}
.win-stat-label {
  font-family: 'DM Mono', monospace;
  font-size: 0.6rem;
  color: var(--ink-faint);
  letter-spacing: 1px;
  text-transform: uppercase;
}

.win-scores {
  display: flex; gap: 32px;
  margin: 8px 0;
}
.win-player {
  text-align: center;
}
.win-player-name {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 4px;
}
.win-player-score {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  font-weight: 800;
  color: var(--gold);
}
.win-player.winner .win-player-score { color: var(--sage); }

/* â•â•â•â•â•â•â•â•â•â•â• HIDDEN INPUT FOR MOBILE â•â•â•â•â•â•â•â•â•â•â• */
#hiddenInput {
  position: fixed;
  top: -100px; left: -100px;
  width: 1px; height: 1px;
  opacity: 0;
  font-size: 16px; /* prevents iOS zoom */
  z-index: -1;
}

/* â•â•â•â•â•â•â•â•â•â•â• ANIMATIONS â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fadeIn 0.3s ease forwards; }

/* â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 400px) {
  .game-header { padding: 6px 8px; }
  .clue-bar { padding: 8px 10px; }
  .hud-badge { font-size: 0.6rem; padding: 2px 8px; }
}
</style>
</head>
<body>

<!-- Hidden input for mobile keyboard capture -->
<input type="text" id="hiddenInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN: LOBBY â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screenLobby" class="screen active">
  <div class="lobby-masthead">
    <div class="lobby-rule"></div>
    <div class="lobby-title font-display">Maria's Word Vault</div>
    <div class="lobby-subtitle">A Family Crossword</div>
  </div>

  <div class="lobby-form">
    <div class="form-label">Your Name</div>
    <input type="text" id="inputName" class="form-input" placeholder="Enter your name" maxlength="20">

    <div class="form-label">Puzzle</div>
    <div class="puzzle-picker">
      <button class="puzzle-btn selected" onclick="setPuzzleType('random')">ğŸ“° Daily</button>
      <button class="puzzle-btn" onclick="setPuzzleType('custom')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family</button>
    </div>

    <div id="customPuzzleArea" style="display:none">
      <select id="customPuzzleSelect" class="custom-puzzle-select">
        <option value="">Loading puzzles...</option>
      </select>
    </div>

    <div class="form-label">Mode</div>
    <div class="mode-picker">
      <button class="mode-btn selected" onclick="setMode('solo')">ğŸ§© Solo</button>
      <button class="mode-btn" onclick="setMode('collaborative')">ğŸ¤ğŸ¾ Co-op</button>
      <button class="mode-btn" onclick="setMode('competitive')">âš”ï¸ Vs</button>
    </div>

    <div id="roomArea" style="display:none">
      <div class="form-label">Room Code</div>
      <div class="room-row">
        <input type="text" id="inputRoom" class="form-input" placeholder="ABCDE" maxlength="5">
        <button class="btn-primary btn-gold" style="width:auto;padding:12px 18px" onclick="joinRoom()">Join</button>
      </div>
    </div>

    <div class="lobby-actions">
      <button id="btnPlay" class="btn-primary btn-gold" onclick="startGame()">Begin Puzzle</button>
    </div>

    <div class="lobby-divider"><span>or</span></div>
    <a href="builder.html" class="btn-primary btn-outline" style="text-align:center;text-decoration:none;display:block">âœï¸ Build a Family Puzzle</a>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN: WAITING ROOM â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screenWaiting" class="screen">
  <div class="waiting-title font-display">Waiting for Player 2</div>
  <div class="room-code-box" id="waitingRoomCode">-----</div>
  <div class="share-url" id="shareUrl" onclick="copyShareUrl()">tap to copy link</div>
  <div class="player-slots">
    <div class="player-slot connected" id="slotP1"><span class="dot"></span><span id="slotP1Name">Player 1</span></div>
    <div class="player-slot" id="slotP2"><span class="dot"></span><span id="slotP2Name">Waiting...</span></div>
  </div>
  <div class="waiting-spinner"></div>
  <button class="btn-primary btn-outline" style="max-width:200px;margin-top:12px" onclick="leaveRoom()">â† Back</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN: GAME â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screenGame" class="screen">
  <div class="game-header">
    <div class="game-header-left">
      <button class="game-back-btn" onclick="leaveRoom()">â†</button>
      <span class="game-title-sm font-display">Maria's Word Vault</span>
    </div>
    <div class="game-header-right">
      <div class="hud-badge">â± <span class="val" id="hudTimer">0:00</span></div>
      <div class="hud-badge" id="hudScoreBadge">âœ“ <span class="val" id="hudScore">0</span></div>
    </div>
  </div>

  <div class="clue-bar" id="clueBar" onclick="toggleClueDrawer()">
    <span class="clue-number" id="activeClueNum">â€”</span>
    <span class="clue-text" id="activeClueText">Tap a cell to begin</span>
  </div>

  <div class="grid-wrapper" id="gridWrapper">
    <div class="crossword-grid" id="crosswordGrid"></div>
  </div>

  <div class="keyboard-bar">
    <button class="kb-btn active" id="btnAcross" onclick="setDirection('across')">ACROSS â†’</button>
    <button class="kb-btn" id="btnDown" onclick="setDirection('down')">DOWN â†“</button>
    <button class="kb-btn-icon" onclick="toggleClueDrawer()" title="Show clues">â˜°</button>
  </div>

  <!-- Clue drawer -->
  <div class="clue-drawer" id="clueDrawer">
    <div class="clue-drawer-handle" onclick="toggleClueDrawer()"></div>
    <div class="clue-section">
      <div class="clue-section-title">Across</div>
      <div id="clueListAcross"></div>
    </div>
    <div class="clue-section">
      <div class="clue-section-title">Down</div>
      <div id="clueListDown"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN: WIN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screenWin" class="screen">
  <div class="win-ornament">ğŸ†</div>
  <div class="win-title font-display" id="winTitle">Puzzle Complete!</div>
  <div class="win-subtitle" id="winSubtitle"></div>
  <div class="win-stats" id="winStats"></div>
  <div class="win-scores" id="winScores" style="display:none"></div>
  <button class="btn-primary btn-gold" style="max-width:240px" onclick="backToLobby()">Play Again</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• FIREBASE SDK â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/*  MARIA'S WORD VAULT â€” Game Engine                      */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Firebase config â€” DO NOT CHANGE
const firebaseConfig = {
  apiKey: "AIzaSyDkqQsKeNwL4qL5e-J1P5S3UE1puzcOaC0",
  authDomain: "marias-word-vault.firebaseapp.com",
  databaseURL: "https://marias-word-vault-default-rtdb.firebaseio.com",
  projectId: "marias-word-vault",
  storageBucket: "marias-word-vault.firebasestorage.app",
  messagingSenderId: "605567866404",
  appId: "1:605567866404:web:9dc0e6543e20e11105eab1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â• */
let state = {
  playerName: '',
  playerId: '',
  roomCode: '',
  mode: 'solo',
  puzzleType: 'random',
  puzzle: null,
  grid: [],
  selectedCell: null,
  direction: 'across',
  clues: { across: [], down: [] },
  answers: {},
  scores: { p1: 0, p2: 0 },
  timerStart: null,
  timerInterval: null,
  roomRef: null,
  customPuzzles: [],
  selectedCustomPuzzle: null,
  gameComplete: false,
  listeners: [],
};

/* â•â•â•â•â•â•â•â•â•â•â• EMBEDDED PUZZLES (REAL CLUES) â•â•â•â•â•â•â•â•â•â•â• */
const EMBEDDED_PUZZLES = [
  {
    "title": "Morning Brew",
    "size": 9,
    "words": [
      {"answer":"TOAST","clue":"Breakfast bread","row":4,"col":2,"dir":"across","number":6},
      {"answer":"STEAM","clue":"Rising from a hot cup","row":1,"col":4,"dir":"down","number":3},
      {"answer":"STARE","clue":"Gaze intently","row":3,"col":2,"dir":"down","number":5},
      {"answer":"TASTE","clue":"Sense on the tongue","row":1,"col":6,"dir":"down","number":4},
      {"answer":"TREAT","clue":"Halloween handout","row":7,"col":0,"dir":"across","number":7},
      {"answer":"TALES","clue":"Bedtime stories","row":1,"col":0,"dir":"across","number":2},
      {"answer":"STORE","clue":"Shop","row":0,"col":0,"dir":"down","number":1}
    ]
  },
  {
    "title": "City Lights",
    "size": 9,
    "words": [
      {"answer":"TOWER","clue":"Eiffel or Babel","row":4,"col":2,"dir":"across","number":6},
      {"answer":"METRO","clue":"Subway system","row":2,"col":2,"dir":"down","number":4},
      {"answer":"ROUTE","clue":"Planned path","row":0,"col":5,"dir":"down","number":2},
      {"answer":"STONE","clue":"Rock, or a Rolling one","row":6,"col":0,"dir":"across","number":7},
      {"answer":"OUTER","clue":"Not inner","row":2,"col":4,"dir":"across","number":5},
      {"answer":"VOTER","clue":"Election participant","row":0,"col":1,"dir":"across","number":1},
      {"answer":"TORN","clue":"Ripped","row":0,"col":8,"dir":"down","number":3}
    ]
  },
  {
    "title": "Garden Path",
    "size": 9,
    "words": [
      {"answer":"PLANT","clue":"Put in the ground","row":4,"col":2,"dir":"across","number":4},
      {"answer":"PETAL","clue":"Rose part","row":1,"col":4,"dir":"down","number":1},
      {"answer":"APPLE","clue":"Pie fruit","row":2,"col":2,"dir":"down","number":3},
      {"answer":"PANEL","clue":"Discussion group","row":2,"col":1,"dir":"across","number":2},
      {"answer":"TRAIL","clue":"Hiking path","row":4,"col":6,"dir":"down","number":5},
      {"answer":"PAINT","clue":"Canvas medium","row":7,"col":4,"dir":"across","number":7},
      {"answer":"PLATE","clue":"Dinner dish","row":4,"col":8,"dir":"down","number":6}
    ]
  },
  {
    "title": "Ocean View",
    "size": 9,
    "words": [
      {"answer":"SHORE","clue":"Beach edge","row":4,"col":2,"dir":"across","number":4},
      {"answer":"HORSE","clue":"Riding animal","row":3,"col":4,"dir":"down","number":2},
      {"answer":"HASTE","clue":"Hurry","row":2,"col":2,"dir":"down","number":1},
      {"answer":"HEART","clue":"Pumping organ","row":3,"col":6,"dir":"down","number":3},
      {"answer":"HEAT","clue":"Summer complaint","row":7,"col":3,"dir":"across","number":5}
    ]
  },
  {
    "title": "Night Sky",
    "size": 9,
    "words": [
      {"answer":"STARS","clue":"Twinkle in the sky","row":4,"col":2,"dir":"across","number":7},
      {"answer":"SMART","clue":"Clever","row":2,"col":4,"dir":"down","number":6},
      {"answer":"STORM","clue":"Thunder and lightning","row":6,"col":3,"dir":"across","number":8},
      {"answer":"ROAST","clue":"Cook in the oven","row":1,"col":2,"dir":"down","number":4},
      {"answer":"MARTS","clue":"Discount stores","row":0,"col":6,"dir":"down","number":2},
      {"answer":"TRAMS","clue":"City rail cars","row":0,"col":3,"dir":"across","number":1},
      {"answer":"ATOMS","clue":"Tiny particles","row":2,"col":0,"dir":"across","number":5},
      {"answer":"MAST","clue":"Ship's pole","row":1,"col":0,"dir":"down","number":3}
    ]
  }
];

/* â•â•â•â•â•â•â•â•â•â•â• PUZZLE ENGINE â•â•â•â•â•â•â•â•â•â•â• */

function buildPuzzleFromEmbedded(data) {
  const size = data.size;
  const gridData = Array.from({ length: size }, () => Array(size).fill('#'));

  // Place words on grid
  for (const w of data.words) {
    for (let i = 0; i < w.answer.length; i++) {
      const r = w.dir === 'across' ? w.row : w.row + i;
      const c = w.dir === 'across' ? w.col + i : w.col;
      if (r < size && c < size) {
        gridData[r][c] = w.answer[i];
      }
    }
  }

  const across = data.words.filter(w => w.dir === 'across').map(w => ({
    number: w.number, clue: w.clue, answer: w.answer,
    row: w.row, col: w.col, dir: 'across'
  }));
  const down = data.words.filter(w => w.dir === 'down').map(w => ({
    number: w.number, clue: w.clue, answer: w.answer,
    row: w.row, col: w.col, dir: 'down'
  }));

  const answers = {};
  for (const w of data.words) {
    answers[`${w.dir}_${w.number}`] = w.answer;
  }

  return {
    source: 'embedded',
    title: data.title,
    gridData,
    clues: { across, down },
    answers
  };
}

function getRandomPuzzle() {
  const idx = Math.floor(Math.random() * EMBEDDED_PUZZLES.length);
  return buildPuzzleFromEmbedded(EMBEDDED_PUZZLES[idx]);
}

async function fetchCustomPuzzles() {
  try {
    const snap = await db.ref('custom_puzzles').orderByChild('created').limitToLast(20).once('value');
    const puzzles = [];
    snap.forEach(child => {
      puzzles.push({ id: child.key, ...child.val() });
    });
    state.customPuzzles = puzzles.reverse();
    renderCustomPuzzleSelect();
  } catch (e) {
    console.log('No custom puzzles found:', e.message);
  }
}

function renderCustomPuzzleSelect() {
  const sel = document.getElementById('customPuzzleSelect');
  sel.innerHTML = '';
  if (state.customPuzzles.length === 0) {
    sel.innerHTML = '<option value="">No family puzzles yet â€” build one!</option>';
    return;
  }
  sel.innerHTML = '<option value="">Choose a puzzle...</option>';
  for (const p of state.customPuzzles) {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.title || 'Untitled Puzzle';
    sel.appendChild(opt);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â• UI HELPERS â•â•â•â•â•â•â•â•â•â•â• */

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function setMode(mode) {
  state.mode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
  event.target.classList.add('selected');

  const roomArea = document.getElementById('roomArea');
  const btnPlay = document.getElementById('btnPlay');

  if (mode === 'solo') {
    roomArea.style.display = 'none';
    btnPlay.textContent = 'Begin Puzzle';
    btnPlay.onclick = startGame;
    btnPlay.style.display = '';
  } else {
    roomArea.style.display = '';
    btnPlay.textContent = 'Create Room';
    btnPlay.onclick = createRoom;
    btnPlay.style.display = '';
  }
}

function setPuzzleType(type) {
  state.puzzleType = type;
  document.querySelectorAll('.puzzle-btn').forEach(b => b.classList.remove('selected'));
  event.target.classList.add('selected');
  document.getElementById('customPuzzleArea').style.display = type === 'custom' ? '' : 'none';
  if (type === 'custom') fetchCustomPuzzles();
}

function setDirection(dir) {
  state.direction = dir;
  document.getElementById('btnAcross').classList.toggle('active', dir === 'across');
  document.getElementById('btnDown').classList.toggle('active', dir === 'down');
  if (state.selectedCell) {
    highlightWord();
    updateActiveClue();
  }
}

function toggleClueDrawer() {
  document.getElementById('clueDrawer').classList.toggle('open');
}

/* â•â•â•â•â•â•â•â•â•â•â• GAME FLOW â•â•â•â•â•â•â•â•â•â•â• */

function startGame() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { document.getElementById('inputName').focus(); return; }

  state.playerName = name;
  state.playerId = 'solo';
  state.mode = 'solo';

  let puzzle;
  if (state.puzzleType === 'custom') {
    const sel = document.getElementById('customPuzzleSelect');
    const id = sel.value;
    if (!id) { alert('Pick a family puzzle!'); return; }
    const found = state.customPuzzles.find(p => p.id === id);
    if (found) {
      puzzle = found;
    } else {
      puzzle = getRandomPuzzle();
    }
  } else {
    puzzle = getRandomPuzzle();
  }

  state.puzzle = puzzle;
  initGame();
}

function createRoom() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { document.getElementById('inputName').focus(); return; }

  state.playerName = name;
  state.playerId = 'p1';
  state.roomCode = generateRoomCode();

  let puzzle;
  if (state.puzzleType === 'custom') {
    const sel = document.getElementById('customPuzzleSelect');
    const id = sel.value;
    const found = state.customPuzzles.find(p => p.id === id);
    puzzle = found || getRandomPuzzle();
  } else {
    puzzle = getRandomPuzzle();
  }

  state.puzzle = puzzle;

  const roomRef = db.ref('rooms/' + state.roomCode);
  state.roomRef = roomRef;

  roomRef.set({
    p1: { name: state.playerName, connected: true },
    p2: { name: '', connected: false },
    mode: state.mode,
    puzzle: puzzle,
    cells: {},
    scores: { p1: 0, p2: 0 },
    cursors: {},
    status: 'waiting',
    timerStart: null,
    created: firebase.database.ServerValue.TIMESTAMP
  });

  // Show waiting screen
  document.getElementById('waitingRoomCode').textContent = state.roomCode;
  const shareLink = `${window.location.origin}${window.location.pathname}?room=${state.roomCode}`;
  document.getElementById('shareUrl').textContent = shareLink;
  document.getElementById('slotP1Name').textContent = state.playerName;
  showScreen('screenWaiting');

  // Listen for p2
  roomRef.child('p2').on('value', snap => {
    const p2 = snap.val();
    if (p2 && p2.connected) {
      document.getElementById('slotP2').classList.add('connected');
      document.getElementById('slotP2Name').textContent = p2.name;
      // Start game
      roomRef.update({ status: 'playing', timerStart: firebase.database.ServerValue.TIMESTAMP });
      initGame();
    }
  });
}

function joinRoom() {
  const name = document.getElementById('inputName').value.trim();
  const code = document.getElementById('inputRoom').value.trim().toUpperCase();
  if (!name) { document.getElementById('inputName').focus(); return; }
  if (!code || code.length < 4) { document.getElementById('inputRoom').focus(); return; }

  state.playerName = name;
  state.roomCode = code;
  state.playerId = 'p2';

  const roomRef = db.ref('rooms/' + code);
  state.roomRef = roomRef;

  roomRef.once('value').then(snap => {
    if (!snap.exists()) {
      alert('Room not found!');
      return;
    }
    const room = snap.val();
    state.mode = room.mode;
    state.puzzle = room.puzzle;

    roomRef.child('p2').set({ name: state.playerName, connected: true });

    // Listen for status change
    roomRef.child('status').on('value', snap => {
      if (snap.val() === 'playing') {
        initGame();
      }
    });

    // Show waiting briefly
    document.getElementById('waitingRoomCode').textContent = code;
    document.getElementById('slotP1Name').textContent = room.p1.name;
    document.getElementById('slotP2Name').textContent = state.playerName;
    document.getElementById('slotP2').classList.add('connected');
    showScreen('screenWaiting');
  });
}

function generateRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
  let code = '';
  for (let i = 0; i < 5; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

function copyShareUrl() {
  const text = document.getElementById('shareUrl').textContent;
  navigator.clipboard?.writeText(text);
  document.getElementById('shareUrl').textContent = 'âœ“ Copied!';
  setTimeout(() => {
    document.getElementById('shareUrl').textContent = text;
  }, 2000);
}

/* â•â•â•â•â•â•â•â•â•â•â• INIT GAME â•â•â•â•â•â•â•â•â•â•â• */

function initGame() {
  state.gameComplete = false;
  state.scores = { p1: 0, p2: 0 };
  state.selectedCell = null;
  state.direction = 'across';

  const puzzle = state.puzzle;
  const gridData = puzzle.gridData;
  const rows = gridData.length;
  const cols = gridData[0].length;

  // Build internal grid
  state.grid = [];
  for (let r = 0; r < rows; r++) {
    state.grid[r] = [];
    for (let c = 0; c < cols; c++) {
      const isBlack = gridData[r][c] === '#';
      state.grid[r][c] = {
        letter: isBlack ? '#' : gridData[r][c],
        isBlack,
        number: null,
        filled: { shared: '', p1: '', p2: '' },
        acrossClue: null,
        downClue: null,
      };
    }
  }

  // Assign clue numbers to cells
  state.clues = puzzle.clues;
  for (const dir of ['across', 'down']) {
    for (const clue of state.clues[dir]) {
      if (state.grid[clue.row] && state.grid[clue.row][clue.col]) {
        state.grid[clue.row][clue.col].number = clue.number;
      }
    }
  }

  // Map cells to their clues
  for (const clue of state.clues.across) {
    for (let i = 0; i < clue.answer.length; i++) {
      const c = clue.col + i;
      if (state.grid[clue.row] && state.grid[clue.row][c]) {
        state.grid[clue.row][c].acrossClue = clue;
      }
    }
  }
  for (const clue of state.clues.down) {
    for (let i = 0; i < clue.answer.length; i++) {
      const r = clue.row + i;
      if (state.grid[r] && state.grid[r][clue.col]) {
        state.grid[r][clue.col].downClue = clue;
      }
    }
  }

  state.answers = puzzle.answers;

  // Build DOM
  buildGrid(rows, cols);
  buildCluePanel();

  // Calculate cell size
  calcAndSetCellSize(rows, cols);

  // Timer
  state.timerStart = Date.now();
  clearInterval(state.timerInterval);
  state.timerInterval = setInterval(updateTimer, 1000);

  // Show game screen
  showScreen('screenGame');

  // Update HUD
  updateHUD();

  // Setup Firebase listeners for multiplayer
  if (state.mode !== 'solo' && state.roomRef) {
    listenRoom();
  }

  // Listen for window resize
  window.addEventListener('resize', () => calcAndSetCellSize(rows, cols));
}

function calcAndSetCellSize(rows, cols) {
  const wrapper = document.getElementById('gridWrapper');
  const availW = wrapper.clientWidth - 16;
  const availH = wrapper.clientHeight - 16;
  const byWidth = Math.floor(availW / cols);
  const byHeight = Math.floor(availH / rows);
  const cellSize = Math.min(byWidth, byHeight, 56);
  document.getElementById('crosswordGrid').style.setProperty('--cell-size', cellSize + 'px');
}

/* â•â•â•â•â•â•â•â•â•â•â• BUILD GRID â•â•â•â•â•â•â•â•â•â•â• */

function buildGrid(rows, cols) {
  const grid = document.getElementById('crosswordGrid');
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;
  grid.style.gridTemplateRows = `repeat(${rows}, var(--cell-size))`;

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const cell = document.createElement('div');
      cell.className = 'grid-cell';
      cell.dataset.row = r;
      cell.dataset.col = c;

      const data = state.grid[r][c];

      if (data.isBlack) {
        cell.classList.add('black');
      } else {
        // Number
        if (data.number) {
          const numEl = document.createElement('span');
          numEl.className = 'cell-number';
          numEl.textContent = data.number;
          cell.appendChild(numEl);
        }

        // Letter display
        const letterEl = document.createElement('span');
        letterEl.className = 'cell-letter';
        letterEl.id = `letter_${r}_${c}`;
        cell.appendChild(letterEl);

        // Click handler
        cell.addEventListener('click', () => handleCellClick(r, c));
        cell.addEventListener('touchend', (e) => {
          e.preventDefault();
          handleCellClick(r, c);
        });
      }

      grid.appendChild(cell);
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â• BUILD CLUE PANEL â•â•â•â•â•â•â•â•â•â•â• */

function buildCluePanel() {
  for (const dir of ['across', 'down']) {
    const container = document.getElementById(dir === 'across' ? 'clueListAcross' : 'clueListDown');
    container.innerHTML = '';
    for (const clue of state.clues[dir]) {
      const item = document.createElement('div');
      item.className = 'clue-item';
      item.id = `clue_${dir}_${clue.number}`;
      item.innerHTML = `
        <span class="clue-item-num">${clue.number}</span>
        <span class="clue-item-text">${clue.clue}</span>
      `;
      item.addEventListener('click', () => {
        state.direction = dir;
        document.getElementById('btnAcross').classList.toggle('active', dir === 'across');
        document.getElementById('btnDown').classList.toggle('active', dir === 'down');
        handleCellClick(clue.row, clue.col);
        document.getElementById('clueDrawer').classList.remove('open');
      });
      container.appendChild(item);
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â• CELL INTERACTION â•â•â•â•â•â•â•â•â•â•â• */

function handleCellClick(r, c) {
  if (state.grid[r][c].isBlack) return;

  // If clicking the same cell, toggle direction
  if (state.selectedCell && state.selectedCell.row === r && state.selectedCell.col === c) {
    state.direction = state.direction === 'across' ? 'down' : 'across';
    document.getElementById('btnAcross').classList.toggle('active', state.direction === 'across');
    document.getElementById('btnDown').classList.toggle('active', state.direction === 'down');
  }

  state.selectedCell = { row: r, col: c };
  highlightWord();
  updateActiveClue();
  focusHiddenInput();

  // Sync cursor to Firebase
  if (state.roomRef) {
    state.roomRef.child(`cursors/${state.playerId}`).set({ row: r, col: c });
  }
}

function highlightWord() {
  // Clear all highlights
  document.querySelectorAll('.grid-cell').forEach(el => {
    el.classList.remove('selected', 'word-highlight');
  });

  if (!state.selectedCell) return;

  const { row, col } = state.selectedCell;
  const dir = state.direction;
  const cellData = state.grid[row][col];
  const clue = dir === 'across' ? cellData.acrossClue : cellData.downClue;

  // If no clue in this direction, try the other
  if (!clue) {
    const altClue = dir === 'across' ? cellData.downClue : cellData.acrossClue;
    if (altClue) {
      state.direction = dir === 'across' ? 'down' : 'across';
      document.getElementById('btnAcross').classList.toggle('active', state.direction === 'across');
      document.getElementById('btnDown').classList.toggle('active', state.direction === 'down');
      highlightWord();
      return;
    }
  }

  if (clue) {
    // Highlight all cells in this word
    for (let i = 0; i < clue.answer.length; i++) {
      const cr = clue.dir === 'across' ? clue.row : clue.row + i;
      const cc = clue.dir === 'across' ? clue.col + i : clue.col;
      const el = getCellElement(cr, cc);
      if (el) el.classList.add('word-highlight');
    }
  }

  // Highlight active cell
  const activeEl = getCellElement(row, col);
  if (activeEl) activeEl.classList.add('selected');
}

function updateActiveClue() {
  if (!state.selectedCell) return;
  const { row, col } = state.selectedCell;
  const cellData = state.grid[row][col];
  const clue = state.direction === 'across' ? cellData.acrossClue : cellData.downClue;

  if (clue) {
    document.getElementById('activeClueNum').textContent = `${clue.number} ${clue.dir === 'across' ? 'A' : 'D'}`;
    document.getElementById('activeClueText').textContent = clue.clue;
  }
}

function getCellElement(r, c) {
  return document.querySelector(`.grid-cell[data-row="${r}"][data-col="${c}"]`);
}

function focusHiddenInput() {
  const input = document.getElementById('hiddenInput');
  input.value = '';
  input.focus({ preventScroll: true });
}

/* â•â•â•â•â•â•â•â•â•â•â• KEYBOARD INPUT â•â•â•â•â•â•â•â•â•â•â• */

// Desktop: keydown on document
document.addEventListener('keydown', handleKeydown);

// Mobile: input event on hidden input
document.getElementById('hiddenInput').addEventListener('input', (e) => {
  const val = e.target.value;
  if (val && val.length > 0) {
    const letter = val.slice(-1).toUpperCase();
    if (/^[A-Z]$/.test(letter)) {
      typeLetter(letter);
    }
    e.target.value = '';
  }
});

// Also handle backspace via keydown on the hidden input
document.getElementById('hiddenInput').addEventListener('keydown', (e) => {
  if (e.key === 'Backspace') {
    e.preventDefault();
    handleBackspace();
  }
});

function handleKeydown(e) {
  if (!state.selectedCell) return;
  // Don't capture if focused on a form input other than hiddenInput
  if (document.activeElement && document.activeElement.tagName === 'INPUT' && document.activeElement.id !== 'hiddenInput') return;

  if (e.key === 'ArrowUp') { e.preventDefault(); moveSelection(0, -1); return; }
  if (e.key === 'ArrowDown') { e.preventDefault(); moveSelection(0, 1); return; }
  if (e.key === 'ArrowLeft') { e.preventDefault(); moveSelection(-1, 0); return; }
  if (e.key === 'ArrowRight') { e.preventDefault(); moveSelection(1, 0); return; }
  if (e.key === 'Tab') {
    e.preventDefault();
    state.direction = state.direction === 'across' ? 'down' : 'across';
    document.getElementById('btnAcross').classList.toggle('active', state.direction === 'across');
    document.getElementById('btnDown').classList.toggle('active', state.direction === 'down');
    highlightWord();
    updateActiveClue();
    return;
  }
  if (e.key === 'Backspace' || e.key === 'Delete') {
    e.preventDefault();
    handleBackspace();
    return;
  }
  if (e.key === ' ') {
    e.preventDefault();
    // Toggle direction like NYT
    state.direction = state.direction === 'across' ? 'down' : 'across';
    document.getElementById('btnAcross').classList.toggle('active', state.direction === 'across');
    document.getElementById('btnDown').classList.toggle('active', state.direction === 'down');
    highlightWord();
    updateActiveClue();
    return;
  }

  const letter = e.key.toUpperCase();
  if (/^[A-Z]$/.test(letter)) {
    e.preventDefault();
    typeLetter(letter);
  }
}

function typeLetter(letter) {
  if (!state.selectedCell || state.gameComplete) return;
  const { row, col } = state.selectedCell;

  setLetter(row, col, letter);
  advanceCursor();
}

function handleBackspace() {
  if (!state.selectedCell || state.gameComplete) return;
  const { row, col } = state.selectedCell;

  // If current cell has a letter, delete it
  const currentLetter = getDisplayedLetter(row, col);
  if (currentLetter) {
    setLetter(row, col, '');
  } else {
    // Move back first, then delete
    retreatCursor();
    if (state.selectedCell) {
      const { row: nr, col: nc } = state.selectedCell;
      setLetter(nr, nc, '');
    }
  }
}

function getDisplayedLetter(r, c) {
  if (state.mode === 'solo') {
    return state.grid[r][c].filled.shared || '';
  } else if (state.mode === 'collaborative') {
    return state.grid[r][c].filled.shared || '';
  } else {
    return state.grid[r][c].filled[state.playerId] || '';
  }
}

function setLetter(row, col, letter) {
  if (state.mode === 'solo') {
    state.grid[row][col].filled.shared = letter;
    updateCellDisplay(row, col);
    checkCompletion();
  } else if (state.roomRef) {
    const cellKey = `${row}_${col}`;
    if (state.mode === 'collaborative') {
      state.roomRef.child(`cells/${cellKey}`).set({
        letter: letter,
        owner: state.playerId
      });
    } else {
      // Competitive
      state.roomRef.child(`cells/${cellKey}/${state.playerId}`).set(letter);
    }
    // Also update local for immediate feedback
    if (state.mode === 'competitive') {
      state.grid[row][col].filled[state.playerId] = letter;
    } else {
      state.grid[row][col].filled.shared = letter;
    }
    updateCellDisplay(row, col);
    checkCompletion();
  }
}

function updateCellDisplay(r, c) {
  const el = document.getElementById(`letter_${r}_${c}`);
  if (!el) return;

  let letter;
  if (state.mode === 'competitive') {
    letter = state.grid[r][c].filled[state.playerId] || '';
  } else {
    letter = state.grid[r][c].filled.shared || '';
  }
  el.textContent = letter;
}

function advanceCursor() {
  if (!state.selectedCell) return;
  let { row, col } = state.selectedCell;
  const rows = state.grid.length;
  const cols = state.grid[0].length;

  if (state.direction === 'across') {
    col++;
    while (col < cols && state.grid[row][col].isBlack) col++;
    if (col >= cols) return;
  } else {
    row++;
    while (row < rows && state.grid[row][col].isBlack) row++;
    if (row >= rows) return;
  }

  state.selectedCell = { row, col };
  highlightWord();
  updateActiveClue();

  if (state.roomRef) {
    state.roomRef.child(`cursors/${state.playerId}`).set({ row, col });
  }
}

function retreatCursor() {
  if (!state.selectedCell) return;
  let { row, col } = state.selectedCell;

  if (state.direction === 'across') {
    col--;
    while (col >= 0 && state.grid[row][col].isBlack) col--;
    if (col < 0) return;
  } else {
    row--;
    while (row >= 0 && state.grid[row][col].isBlack) row--;
    if (row < 0) return;
  }

  state.selectedCell = { row, col };
  highlightWord();
  updateActiveClue();
}

function moveSelection(dx, dy) {
  if (!state.selectedCell) return;
  let { row, col } = state.selectedCell;
  const rows = state.grid.length;
  const cols = state.grid[0].length;

  // dx maps to col, dy maps to row
  let nr = row + dy;
  let nc = col + dx;

  // Skip black cells
  while (nr >= 0 && nr < rows && nc >= 0 && nc < cols && state.grid[nr][nc].isBlack) {
    nr += dy; nc += dx;
  }

  if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && !state.grid[nr][nc].isBlack) {
    state.selectedCell = { row: nr, col: nc };
    // Set direction based on arrow key
    if (dx !== 0) state.direction = 'across';
    if (dy !== 0) state.direction = 'down';
    document.getElementById('btnAcross').classList.toggle('active', state.direction === 'across');
    document.getElementById('btnDown').classList.toggle('active', state.direction === 'down');
    highlightWord();
    updateActiveClue();
    focusHiddenInput();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â• FIREBASE LISTENERS â•â•â•â•â•â•â•â•â•â•â• */

function listenRoom() {
  if (!state.roomRef) return;

  // Listen for cell changes
  const cellListener = state.roomRef.child('cells').on('value', snap => {
    const cells = snap.val();
    if (!cells) return;
    updateGridFromFirebase(cells);
    checkCompletion();
  });

  // Listen for peer cursor
  const peerId = state.playerId === 'p1' ? 'p2' : 'p1';
  const cursorListener = state.roomRef.child(`cursors/${peerId}`).on('value', snap => {
    const cursor = snap.val();
    // Clear old peer cursors
    document.querySelectorAll('.peer-cursor').forEach(el => el.classList.remove('peer-cursor'));
    if (cursor) {
      const el = getCellElement(cursor.row, cursor.col);
      if (el) el.classList.add('peer-cursor');
    }
  });

  // Listen for scores
  const scoreListener = state.roomRef.child('scores').on('value', snap => {
    const scores = snap.val();
    if (scores) {
      state.scores = scores;
      updateHUD();
    }
  });
}

function updateGridFromFirebase(cells) {
  for (const key of Object.keys(cells)) {
    const [r, c] = key.split('_').map(Number);
    if (!state.grid[r] || !state.grid[r][c]) continue;

    if (state.mode === 'collaborative') {
      const data = cells[key];
      state.grid[r][c].filled.shared = data.letter || '';
    } else {
      // Competitive
      const data = cells[key];
      if (data.p1 !== undefined) state.grid[r][c].filled.p1 = data.p1;
      if (data.p2 !== undefined) state.grid[r][c].filled.p2 = data.p2;
    }
    updateCellDisplay(r, c);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â• COMPLETION CHECK â•â•â•â•â•â•â•â•â•â•â• */

function checkCompletion() {
  if (state.gameComplete) return;

  let completedWords = 0;
  let totalWords = 0;

  for (const dir of ['across', 'down']) {
    for (const clue of state.clues[dir]) {
      totalWords++;
      let word = '';
      for (let i = 0; i < clue.answer.length; i++) {
        const r = clue.dir === 'across' ? clue.row : clue.row + i;
        const c = clue.dir === 'across' ? clue.col + i : clue.col;

        if (state.mode === 'competitive') {
          word += (state.grid[r][c].filled[state.playerId] || '');
        } else {
          word += (state.grid[r][c].filled.shared || '');
        }
      }

      if (word.toUpperCase() === clue.answer.toUpperCase()) {
        completedWords++;
        // Mark clue as completed in UI
        const clueEl = document.getElementById(`clue_${clue.dir}_${clue.number}`);
        if (clueEl) clueEl.classList.add('completed');
      } else {
        const clueEl = document.getElementById(`clue_${clue.dir}_${clue.number}`);
        if (clueEl) clueEl.classList.remove('completed');
      }
    }
  }

  // Update score display
  document.getElementById('hudScore').textContent = completedWords;

  if (completedWords === totalWords) {
    state.gameComplete = true;
    clearInterval(state.timerInterval);
    showWinScreen();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â• WIN SCREEN â•â•â•â•â•â•â•â•â•â•â• */

function showWinScreen() {
  const elapsed = Math.floor((Date.now() - state.timerStart) / 1000);
  const mins = Math.floor(elapsed / 60);
  const secs = elapsed % 60;
  const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;

  const totalWords = state.clues.across.length + state.clues.down.length;

  if (state.mode === 'solo') {
    document.getElementById('winTitle').textContent = `Nice work, ${state.playerName}!`;
    document.getElementById('winSubtitle').textContent = state.puzzle.title || 'Puzzle Complete';
    document.getElementById('winStats').innerHTML = `
      <div class="win-stat"><div class="win-stat-val">${timeStr}</div><div class="win-stat-label">Time</div></div>
      <div class="win-stat"><div class="win-stat-val">${totalWords}</div><div class="win-stat-label">Words</div></div>
    `;
    document.getElementById('winScores').style.display = 'none';
  } else if (state.mode === 'collaborative') {
    document.getElementById('winTitle').textContent = 'You solved it together! ğŸ¤ğŸ¾';
    document.getElementById('winSubtitle').textContent = `${timeStr}`;
    document.getElementById('winStats').innerHTML = `
      <div class="win-stat"><div class="win-stat-val">${timeStr}</div><div class="win-stat-label">Time</div></div>
      <div class="win-stat"><div class="win-stat-val">${totalWords}</div><div class="win-stat-label">Words</div></div>
    `;
  } else {
    // Competitive
    const p1Score = state.scores.p1 || 0;
    const p2Score = state.scores.p2 || 0;
    const winner = p1Score > p2Score ? 'Player 1' : p2Score > p1Score ? 'Player 2' : 'Tie';
    document.getElementById('winTitle').textContent = winner === 'Tie' ? "It's a tie!" : `${winner} wins!`;
    document.getElementById('winSubtitle').textContent = timeStr;
    document.getElementById('winScores').style.display = 'flex';
    document.getElementById('winScores').innerHTML = `
      <div class="win-player ${p1Score >= p2Score ? 'winner' : ''}">
        <div class="win-player-name">P1</div>
        <div class="win-player-score">${p1Score}</div>
      </div>
      <div class="win-player ${p2Score >= p1Score ? 'winner' : ''}">
        <div class="win-player-name">P2</div>
        <div class="win-player-score">${p2Score}</div>
      </div>
    `;
  }

  showScreen('screenWin');
}

/* â•â•â•â•â•â•â•â•â•â•â• TIMER / HUD â•â•â•â•â•â•â•â•â•â•â• */

function updateTimer() {
  if (!state.timerStart) return;
  const elapsed = Math.floor((Date.now() - state.timerStart) / 1000);
  const mins = Math.floor(elapsed / 60);
  const secs = elapsed % 60;
  document.getElementById('hudTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

function updateHUD() {
  if (state.mode === 'competitive') {
    document.getElementById('hudScoreBadge').innerHTML = `âš”ï¸ <span class="val">${state.scores[state.playerId] || 0}</span>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•â• */

function leaveRoom() {
  clearInterval(state.timerInterval);

  // Clean up Firebase listeners
  if (state.roomRef) {
    state.roomRef.off();
    state.roomRef = null;
  }

  // Close clue drawer
  document.getElementById('clueDrawer').classList.remove('open');

  state.selectedCell = null;
  state.gameComplete = false;
  state.puzzle = null;

  showScreen('screenLobby');
}

function backToLobby() {
  leaveRoom();
}

/* â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â• */

// Check for room code in URL
(function() {
  const params = new URLSearchParams(window.location.search);
  const room = params.get('room');
  if (room) {
    document.getElementById('inputRoom').value = room.toUpperCase();
    // Auto-switch to multiplayer mode
    setMode('collaborative');
    document.querySelectorAll('.mode-btn')[1].classList.add('selected');
    document.querySelectorAll('.mode-btn')[0].classList.remove('selected');
  }
})();

// Prevent iOS zoom on double-tap
document.addEventListener('touchstart', (e) => {
  if (e.target.closest('.grid-cell')) {
    e.preventDefault();
  }
}, { passive: false });

// Keep hidden input focused during game
document.addEventListener('click', (e) => {
  if (document.getElementById('screenGame').classList.contains('active')) {
    if (!e.target.closest('.clue-drawer') && !e.target.closest('.game-header') && !e.target.closest('.keyboard-bar')) {
      setTimeout(() => focusHiddenInput(), 10);
    }
  }
});
</script>
</body>
</html>
