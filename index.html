<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Maria's Word Vault</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;1,400;1,600&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #1a1208;
  --ink-soft: #3d3224;
  --ink-faint: #6b5d4f;
  --paper: #faf7f2;
  --paper-warm: #f5f0e8;
  --paper-dim: #ebe5d9;
  --gold: #c9943a;
  --gold-light: #e8c97a;
  --gold-dim: #8a6420;
  --rust: #b84c2a;
  --sage: #4a7c5e;
  --sage-light: #d4e8dc;
  --blue-select: #a8c8e8;
  --blue-active: #6ba3d6;
  --cell-size: 40px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%; width: 100%;
  overflow: hidden;
  font-family: 'DM Sans', sans-serif;
  background: var(--paper);
  color: var(--ink);
  -webkit-tap-highlight-color: transparent;
  -webkit-text-size-adjust: 100%;
}
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}
.font-display { font-family: 'Playfair Display', Georgia, serif; }
.font-mono { font-family: 'DM Mono', monospace; }

/* ‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê */
.screen {
  display: none;
  position: fixed; inset: 0;
  flex-direction: column;
  align-items: center;
  overflow-y: auto;
  background: var(--paper);
}
.screen.active { display: flex; }

/* ‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê */
#screenLobby { justify-content: center; padding: 24px; gap: 0; }
.lobby-masthead { text-align: center; margin-bottom: 32px; }
.lobby-rule { width: 60px; height: 2px; background: var(--gold); margin: 0 auto 12px; }
.lobby-title { font-family: 'Playfair Display', serif; font-size: clamp(1.6rem, 6vw, 2.4rem); font-weight: 800; color: var(--ink); line-height: 1.1; }
.lobby-subtitle { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--ink-faint); letter-spacing: 3px; text-transform: uppercase; margin-top: 6px; }
.lobby-card { width: 100%; max-width: 380px; }
.lobby-section { margin-bottom: 16px; }
.lobby-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--ink-faint); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
.lobby-input {
  font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 600;
  padding: 10px 14px; border: 2px solid var(--paper-dim); border-radius: 2px;
  background: white; color: var(--ink); width: 100%; outline: none;
  box-shadow: 2px 2px 0 var(--paper-dim); transition: border-color 0.2s;
}
.lobby-input:focus { border-color: var(--gold); }
.mode-row, .puzzle-row { display: flex; gap: 6px; }
.mode-btn, .puzzle-btn {
  flex: 1; font-family: 'DM Sans', sans-serif; font-size: 0.75rem; font-weight: 600;
  padding: 8px 4px; border: 2px solid var(--paper-dim); border-radius: 2px;
  background: white; color: var(--ink-faint); cursor: pointer; text-align: center;
  transition: all 0.15s;
}
.mode-btn.selected, .puzzle-btn.selected {
  border-color: var(--gold); color: var(--ink); background: var(--gold-light);
  box-shadow: 2px 2px 0 var(--gold-dim);
}
.btn-primary {
  font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700;
  width: 100%; padding: 12px; border: none; border-radius: 2px;
  color: white; cursor: pointer; margin-top: 8px; transition: all 0.12s;
}
.btn-gold { background: var(--gold); box-shadow: 0 3px 0 var(--gold-dim); }
.btn-gold:active { transform: translateY(3px); box-shadow: none; }
.btn-sage { background: var(--sage); box-shadow: 0 3px 0 #375e46; }
.btn-sage:active { transform: translateY(3px); box-shadow: none; }
.btn-outline-sm {
  font-family: 'DM Mono', monospace; font-size: 0.7rem; font-weight: 500;
  padding: 6px 12px; border: 2px solid var(--paper-dim); border-radius: 2px;
  background: transparent; color: var(--ink-faint); cursor: pointer;
}
.btn-outline-sm:hover { border-color: var(--gold); color: var(--ink); }
#roomArea { display: none; }
#customPuzzleArea { display: none; }
.lobby-select {
  font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
  padding: 8px 12px; border: 2px solid var(--paper-dim); border-radius: 2px;
  background: white; color: var(--ink); width: 100%; outline: none;
}
.lobby-links { text-align: center; margin-top: 16px; display: flex; gap: 12px; justify-content: center; }
.lobby-links a, .lobby-links button {
  font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--ink-faint);
  text-decoration: none; background: none; border: none; cursor: pointer;
}
.lobby-links a:hover, .lobby-links button:hover { color: var(--gold); }

/* ‚ïê‚ïê‚ïê INSTRUCTIONS ‚ïê‚ïê‚ïê */
#screenInstructions { padding: 24px; justify-content: flex-start; }
.instr-container { max-width: 420px; width: 100%; }
.instr-back { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--ink-faint); cursor: pointer; background: none; border: none; margin-bottom: 20px; }
.instr-back:hover { color: var(--gold); }
.instr-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 800; margin-bottom: 4px; }
.instr-rule { width: 40px; height: 2px; background: var(--gold); margin-bottom: 20px; }
.instr-section { margin-bottom: 20px; }
.instr-heading { font-family: 'DM Mono', monospace; font-size: 0.6rem; letter-spacing: 2px; text-transform: uppercase; color: var(--gold-dim); margin-bottom: 8px; }
.instr-text { font-size: 0.85rem; line-height: 1.6; color: var(--ink-soft); }
.instr-text strong { color: var(--ink); font-weight: 600; }

/* ‚ïê‚ïê‚ïê WAITING ‚ïê‚ïê‚ïê */
#screenWaiting { justify-content: center; padding: 24px; }
.waiting-card { text-align: center; max-width: 380px; }
.waiting-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; }
.waiting-code { font-family: 'DM Mono', monospace; font-size: 2rem; font-weight: 500; color: var(--gold); letter-spacing: 6px; margin: 12px 0; }
.waiting-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--ink-faint); letter-spacing: 2px; text-transform: uppercase; }
.share-url { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--sage); word-break: break-all; cursor: pointer; margin: 8px 0 16px; }
.player-slots { display: flex; gap: 12px; justify-content: center; margin: 20px 0; }
.player-slot {
  padding: 10px 16px; border: 2px solid var(--paper-dim); border-radius: 2px;
  font-family: 'DM Sans', sans-serif; font-size: 0.8rem; color: var(--ink-faint);
  min-width: 120px; text-align: center;
}
.player-slot.connected { border-color: var(--sage); color: var(--sage); background: var(--sage-light); }

/* ‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê */
#screenGame { flex-direction: column; align-items: stretch; overflow: hidden; }
.game-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 6px 12px; border-bottom: 1px solid var(--paper-dim);
  min-height: 36px; flex-shrink: 0;
}
.hud-title { font-family: 'Playfair Display', serif; font-size: 0.85rem; font-weight: 700; }
.hud-right { display: flex; gap: 12px; align-items: center; }
.hud-timer { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--ink-faint); }
.hud-score { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--gold-dim); }
.hud-back { font-size: 1rem; background: none; border: none; cursor: pointer; color: var(--ink-faint); padding: 4px; }
.clue-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 12px; background: var(--paper-warm);
  border-bottom: 1px solid var(--paper-dim);
  min-height: 36px; flex-shrink: 0; cursor: pointer;
}
.clue-bar-num { font-family: 'DM Mono', monospace; font-size: 0.7rem; font-weight: 500; color: var(--gold-dim); white-space: nowrap; }
.clue-bar-text { font-size: 0.8rem; color: var(--ink-soft); flex: 1; }
.grid-wrapper {
  flex: 1; display: flex; align-items: center; justify-content: center;
  padding: 8px; overflow: hidden; min-height: 0;
}
.crossword-grid {
  display: inline-grid; gap: 0;
  border: 2px solid var(--ink);
  box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
}
.grid-cell {
  width: var(--cell-size); height: var(--cell-size);
  border: 0.5px solid #bbb;
  display: flex; align-items: center; justify-content: center;
  position: relative; cursor: pointer;
  background: white; user-select: none;
  transition: background 0.1s;
}
.grid-cell.black { background: var(--ink); cursor: default; }
.grid-cell.selected { background: var(--blue-active) !important; }
.grid-cell.word-highlight { background: var(--blue-select); }
.grid-cell.peer-cursor { box-shadow: inset 0 0 0 2px var(--rust); }
.cell-number {
  position: absolute; top: 1px; left: 2px;
  font-family: 'DM Sans', sans-serif; font-size: calc(var(--cell-size) * 0.22);
  font-weight: 700; color: var(--ink-faint); line-height: 1;
}
.cell-letter {
  font-family: 'DM Sans', sans-serif;
  font-size: calc(var(--cell-size) * 0.48);
  font-weight: 700; color: var(--ink); text-transform: uppercase;
}

/* On-screen keyboard */
.osk {
  flex-shrink: 0; padding: 4px 4px 8px;
  background: var(--paper-dim); border-top: 1px solid #ccc;
}
.osk-row { display: flex; justify-content: center; gap: 3px; margin-bottom: 3px; }
.osk-key {
  font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 700;
  min-width: 26px; height: 38px; border: none; border-radius: 4px;
  background: white; color: var(--ink); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
  transition: background 0.08s;
  flex: 1; max-width: 38px;
}
.osk-key:active { background: var(--blue-select); transform: translateY(1px); box-shadow: none; }
.osk-key.wide { min-width: 44px; max-width: 56px; font-size: 0.7rem; letter-spacing: 0.5px; }
.osk-key.accent { background: var(--gold-light); color: var(--gold-dim); }

/* Direction + clue toggle bar */
.dir-bar {
  display: flex; gap: 0; flex-shrink: 0;
  border-top: 1px solid var(--paper-dim);
  border-bottom: 1px solid var(--paper-dim);
}
.dir-btn {
  flex: 1; font-family: 'DM Mono', monospace; font-size: 0.65rem;
  font-weight: 500; letter-spacing: 1px; text-transform: uppercase;
  padding: 6px; border: none; background: var(--paper-warm);
  color: var(--ink-faint); cursor: pointer; text-align: center;
}
.dir-btn.active { background: var(--gold-light); color: var(--gold-dim); font-weight: 700; }
.dir-btn-clue {
  padding: 6px 14px; border: none; background: var(--paper-warm);
  color: var(--ink-faint); cursor: pointer; font-size: 1.1rem;
  border-left: 1px solid var(--paper-dim);
  font-weight: 700;
}

/* Clue drawer */
.clue-drawer {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--paper); border-top: 2px solid var(--ink);
  transform: translateY(100%); transition: transform 0.3s;
  max-height: 55vh; overflow-y: auto; padding: 16px;
  z-index: 100;
}
.clue-drawer.open { transform: translateY(0); }
.clue-drawer-handle { width: 40px; height: 3px; background: var(--paper-dim); border-radius: 3px; margin: 0 auto 12px; cursor: pointer; }
.clue-section { margin-bottom: 16px; }
.clue-section-title { font-family: 'DM Mono', monospace; font-size: 0.6rem; letter-spacing: 2px; text-transform: uppercase; color: var(--gold-dim); margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid var(--paper-dim); }
.clue-item { display: flex; gap: 6px; padding: 4px 0; cursor: pointer; align-items: baseline; }
.clue-item:hover { background: var(--paper-warm); }
.clue-item-num { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--gold-dim); min-width: 20px; }
.clue-item-text { font-size: 0.8rem; color: var(--ink-soft); }
.clue-item.completed .clue-item-text { text-decoration: line-through; color: var(--ink-faint); }

/* ‚ïê‚ïê‚ïê WIN ‚ïê‚ïê‚ïê */
#screenWin { justify-content: center; padding: 24px; text-align: center; }
.win-ornament { font-size: 3rem; margin-bottom: 12px; }
.win-title { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: 800; margin-bottom: 6px; }
.win-subtitle { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--ink-faint); margin-bottom: 20px; }
.win-stats { display: flex; gap: 24px; justify-content: center; margin-bottom: 24px; }
.win-stat-val { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 800; color: var(--gold); }
.win-stat-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--ink-faint); letter-spacing: 2px; text-transform: uppercase; }
.win-scores { display: flex; gap: 16px; justify-content: center; margin-bottom: 20px; }

.loading-spinner {
  display: inline-block; width: 18px; height: 18px;
  border: 2px solid var(--paper-dim); border-top-color: var(--gold);
  border-radius: 50%; animation: spin 0.8s linear infinite;
  margin-right: 8px; vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }
.puzzle-status { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--ink-faint); margin-top: 8px; text-align: center; min-height: 1.2em; }
</style>
</head>
<body>

<!-- SCREEN: LOBBY -->
<div id="screenLobby" class="screen active">
  <div class="lobby-masthead">
    <div class="lobby-rule"></div>
    <div class="lobby-title font-display">Maria's Word Vault</div>
    <div class="lobby-subtitle font-mono">A Crossword for Two</div>
  </div>
  <div class="lobby-card">
    <div class="lobby-section">
      <div class="lobby-label">Your Name</div>
      <input type="text" id="inputName" class="lobby-input" placeholder="Enter your name" maxlength="20" autocomplete="off">
    </div>
    <div class="lobby-section">
      <div class="lobby-label">Puzzle Source</div>
      <div class="puzzle-row">
        <button class="puzzle-btn selected" onclick="setPuzzleType('random', this)">üì∞ Daily</button>
        <button class="puzzle-btn" onclick="setPuzzleType('custom', this)">üë®‚Äçüë©‚Äçüëß Family</button>
      </div>
      <div id="customPuzzleArea" style="margin-top:8px">
        <select id="customPuzzleSelect" class="lobby-select"></select>
      </div>
    </div>
    <div class="lobby-section">
      <div class="lobby-label">Mode</div>
      <div class="mode-row">
        <button class="mode-btn selected" onclick="setMode('solo', this)">üß© Solo</button>
        <button class="mode-btn" onclick="setMode('collaborative', this)">ü§ùüèæ Co-op</button>
        <button class="mode-btn" onclick="setMode('competitive', this)">‚öîÔ∏è Vs</button>
      </div>
    </div>
    <div class="lobby-section" id="roomArea">
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button class="btn-primary btn-gold" style="flex:1;margin:0" id="btnCreate" onclick="createRoom()">Create Room</button>
      </div>
      <div class="lobby-label">‚Äî Or Join a Room ‚Äî</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input type="text" id="inputRoom" class="lobby-input" placeholder="Enter code" maxlength="5" style="text-transform:uppercase;font-family:'DM Mono',monospace;letter-spacing:3px;text-align:center;flex:1">
        <button class="btn-primary btn-sage" style="width:auto;margin:0;padding:12px 20px" onclick="joinRoom()">Join</button>
      </div>
    </div>
    <button class="btn-primary btn-gold" id="btnPlay" onclick="startGame()">Begin Puzzle</button>
    <div id="puzzleStatus" class="puzzle-status"></div>
    <div class="lobby-links">
      <button onclick="showScreen('screenInstructions')">How to Play</button>
      <a href="builder.html">Puzzle Builder</a>
    </div>
  </div>
</div>

<!-- SCREEN: INSTRUCTIONS -->
<div id="screenInstructions" class="screen">
  <div class="instr-container">
    <button class="instr-back" onclick="showScreen('screenLobby')">‚Üê Back</button>
    <div class="instr-title font-display">How to Play</div>
    <div class="instr-rule"></div>
    <div class="instr-section">
      <div class="instr-heading">The Basics</div>
      <div class="instr-text">Fill in every white square with a letter to complete all the words. Each puzzle is a <strong>5√ó5 mini crossword</strong> with 3 words going across and 3 words going down. Letters are shared where words cross ‚Äî get one right and it helps solve the other.</div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">Controls</div>
      <div class="instr-text">
        <strong>Tap a white cell</strong> to select it. The active word highlights in blue and the clue appears at the top.<br><br>
        <strong>Tap the same cell again</strong> to switch between Across and Down. You can also use the direction buttons or the ‚áÑ DIR key.<br><br>
        <strong>Type a letter</strong> using the on-screen keyboard (or physical keyboard on desktop). The cursor advances automatically.<br><br>
        <strong>‚å´</strong> removes the letter in the current cell, or moves backward if empty.<br><br>
        <strong>‚ò∞</strong> opens the full clue list. Tap any clue to jump to that word on the grid.
      </div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">Game Modes</div>
      <div class="instr-text">
        üß© <strong>Solo</strong> ‚Äî Just you and the puzzle. Race the clock.<br><br>
        ü§ùüèæ <strong>Co-op</strong> ‚Äî Share the board in real time with a partner. One creates a room, the other joins with the code.<br><br>
        ‚öîÔ∏è <strong>Vs</strong> ‚Äî Compete head-to-head on the same puzzle. Each player fills in their own letters.
      </div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">Puzzles</div>
      <div class="instr-text">
        <strong>üì∞ Daily</strong> puzzles are generated fresh using a word API. If the connection is slow, a built-in puzzle loads instead.<br><br>
        <strong>üë®‚Äçüë©‚Äçüëß Family</strong> puzzles are custom-made using the Puzzle Builder. Create your own with personal words and clues.
      </div>
    </div>
    <div class="instr-section">
      <div class="instr-heading">Tips</div>
      <div class="instr-text">Start with the clues you know. Crossing letters will help unlock harder ones. The puzzle is complete when every white cell is correctly filled.</div>
    </div>
    <button class="btn-primary btn-sage" onclick="showScreen('screenLobby')" style="max-width:240px;margin:12px auto 0;display:block">Got It</button>
  </div>
</div>

<!-- SCREEN: WAITING -->
<div id="screenWaiting" class="screen">
  <div class="waiting-card">
    <div class="waiting-title font-display">Waiting for Player 2</div>
    <div class="waiting-label">Room Code</div>
    <div class="waiting-code" id="waitingRoomCode">-----</div>
    <div class="share-url" id="shareUrl" onclick="copyShareUrl()">tap to copy link</div>
    <div class="player-slots">
      <div class="player-slot connected"><div class="waiting-label">Player 1</div><div id="slotP1Name">---</div></div>
      <div class="player-slot" id="slotP2"><div class="waiting-label">Player 2</div><div id="slotP2Name">waiting...</div></div>
    </div>
    <button class="btn-outline-sm" onclick="leaveRoom()">Cancel</button>
  </div>
</div>

<!-- SCREEN: GAME -->
<div id="screenGame" class="screen">
  <div class="game-header">
    <button class="hud-back" onclick="leaveRoom()">‚úï</button>
    <div class="hud-title font-display" id="hudTitle">Puzzle</div>
    <div class="hud-right">
      <div class="hud-score font-mono" id="hudScore">0/6</div>
      <div class="hud-timer font-mono" id="hudTimer">0:00</div>
    </div>
  </div>
  <div class="clue-bar" onclick="toggleClueDrawer()">
    <span class="clue-bar-num" id="activeClueNum">‚Äî</span>
    <span class="clue-bar-text" id="activeClueText">Tap a cell to begin</span>
    <span style="font-size:1rem;color:var(--ink-faint);padding:0 4px;flex-shrink:0">‚ò∞</span>
  </div>
  <div class="grid-wrapper" id="gridWrapper">
    <div class="crossword-grid" id="crosswordGrid"></div>
  </div>
  <div class="dir-bar">
    <button class="dir-btn active" id="btnAcross" onclick="setDirection('across')">Across ‚Üí</button>
    <button class="dir-btn" id="btnDown" onclick="setDirection('down')">Down ‚Üì</button>
    <button class="dir-btn-clue" onclick="toggleClueDrawer()" title="Show clues">‚ò∞</button>
  </div>
  <div class="osk" id="osk">
    <div class="osk-row">
      <button class="osk-key" data-key="Q">Q</button><button class="osk-key" data-key="W">W</button><button class="osk-key" data-key="E">E</button><button class="osk-key" data-key="R">R</button><button class="osk-key" data-key="T">T</button><button class="osk-key" data-key="Y">Y</button><button class="osk-key" data-key="U">U</button><button class="osk-key" data-key="I">I</button><button class="osk-key" data-key="O">O</button><button class="osk-key" data-key="P">P</button>
    </div>
    <div class="osk-row">
      <button class="osk-key" data-key="A">A</button><button class="osk-key" data-key="S">S</button><button class="osk-key" data-key="D">D</button><button class="osk-key" data-key="F">F</button><button class="osk-key" data-key="G">G</button><button class="osk-key" data-key="H">H</button><button class="osk-key" data-key="J">J</button><button class="osk-key" data-key="K">K</button><button class="osk-key" data-key="L">L</button>
    </div>
    <div class="osk-row">
      <button class="osk-key wide accent" data-key="TOGGLE">‚áÑ DIR</button><button class="osk-key" data-key="Z">Z</button><button class="osk-key" data-key="X">X</button><button class="osk-key" data-key="C">C</button><button class="osk-key" data-key="V">V</button><button class="osk-key" data-key="B">B</button><button class="osk-key" data-key="N">N</button><button class="osk-key" data-key="M">M</button><button class="osk-key wide" data-key="BACKSPACE">‚å´</button>
    </div>
  </div>
  <div class="clue-drawer" id="clueDrawer">
    <div class="clue-drawer-handle" onclick="toggleClueDrawer()"></div>
    <div class="clue-section"><div class="clue-section-title">Across</div><div id="clueListAcross"></div></div>
    <div class="clue-section"><div class="clue-section-title">Down</div><div id="clueListDown"></div></div>
  </div>
</div>

<!-- SCREEN: WIN -->
<div id="screenWin" class="screen">
  <div class="win-ornament">üèÜ</div>
  <div class="win-title font-display" id="winTitle">Puzzle Complete!</div>
  <div class="win-subtitle" id="winSubtitle"></div>
  <div class="win-stats" id="winStats"></div>
  <div class="win-scores" id="winScores" style="display:none"></div>
  <button class="btn-primary btn-gold" style="max-width:240px" onclick="backToLobby()">Play Again</button>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/*  MARIA'S WORD VAULT ‚Äî Engine                   */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

firebase.initializeApp({
  apiKey: "AIzaSyDkqQsKeNwL4qL5e-J1P5S3UE1puzcOaC0",
  authDomain: "marias-word-vault.firebaseapp.com",
  databaseURL: "https://marias-word-vault-default-rtdb.firebaseio.com",
  projectId: "marias-word-vault",
  storageBucket: "marias-word-vault.firebasestorage.app",
  messagingSenderId: "605567866404",
  appId: "1:605567866404:web:9dc0e6543e20e11105eab1"
});
const db = firebase.database();

/* STATE */
const state = {
  playerName:'', playerId:'', roomCode:'', mode:'solo',
  puzzleType:'random', puzzle:null, grid:[],
  selectedCell:null, direction:'across',
  clues:{across:[],down:[]}, answers:{},
  scores:{p1:0,p2:0},
  timerStart:null, timerInterval:null, roomRef:null,
  customPuzzles:[], gameComplete:false,
};

/* ‚ïê‚ïê‚ïê EMBEDDED FALLBACK PUZZLES ‚ïê‚ïê‚ïê */
const EMBEDDED_PUZZLES = [
  {"title":"Spark","size":5,"gridData":[["B","L","A","R","E"],["A","#","U","#","R"],["L","I","N","E","R"],["E","#","T","#","E"],["D","O","S","E","D"]],"clues":{"across":[{"number":1,"clue":"Trumpet sound","answer":"BLARE","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Ocean vessel","answer":"LINER","row":2,"col":0,"dir":"across"},{"number":7,"clue":"Gave out medicine","answer":"DOSED","row":4,"col":0,"dir":"across"}],"down":[{"number":1,"clue":"Made into bundles","answer":"BALED","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Parents' sisters","answer":"AUNTS","row":0,"col":2,"dir":"down"},{"number":3,"clue":"Made a mistake","answer":"ERRED","row":0,"col":4,"dir":"down"}]},"answers":{"across_1":"BLARE","across_4":"LINER","across_7":"DOSED","down_1":"BALED","down_2":"AUNTS","down_3":"ERRED"}},
  {"title":"Harbor","size":5,"gridData":[["C","R","A","N","E"],["H","#","E","#","V"],["A","D","O","R","E"],["R","#","N","#","N"],["T","E","S","T","S"]],"clues":{"across":[{"number":1,"clue":"Construction machine or bird","answer":"CRANE","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Worship","answer":"ADORE","row":2,"col":0,"dir":"across"},{"number":7,"clue":"Final exams","answer":"TESTS","row":4,"col":0,"dir":"across"}],"down":[{"number":1,"clue":"Navigation map","answer":"CHART","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Very long time periods","answer":"AEONS","row":0,"col":2,"dir":"down"},{"number":3,"clue":"Makes the score equal","answer":"EVENS","row":0,"col":4,"dir":"down"}]},"answers":{"across_1":"CRANE","across_4":"ADORE","across_7":"TESTS","down_1":"CHART","down_2":"AEONS","down_3":"EVENS"}},
  {"title":"Autumn","size":5,"gridData":[["M","A","P","L","E"],["I","#","E","#","A"],["L","I","N","E","R"],["E","#","N","#","E"],["S","T","E","E","D"]],"clues":{"across":[{"number":1,"clue":"Syrup tree","answer":"MAPLE","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Ship or jacket inner layer","answer":"LINER","row":2,"col":0,"dir":"across"},{"number":7,"clue":"Noble horse","answer":"STEED","row":4,"col":0,"dir":"across"}],"down":[{"number":1,"clue":"Distance units","answer":"MILES","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Tube-shaped pasta","answer":"PENNE","row":0,"col":2,"dir":"down"},{"number":3,"clue":"Like a rabbit, feature-wise","answer":"EARED","row":0,"col":4,"dir":"down"}]},"answers":{"across_1":"MAPLE","across_4":"LINER","across_7":"STEED","down_1":"MILES","down_2":"PENNE","down_3":"EARED"}},
  {"title":"Focus","size":5,"gridData":[["S","C","O","P","E"],["E","#","W","#","A"],["T","O","N","E","R"],["U","#","E","#","N"],["P","E","R","K","S"]],"clues":{"across":[{"number":1,"clue":"Range of view","answer":"SCOPE","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Printer cartridge","answer":"TONER","row":2,"col":0,"dir":"across"},{"number":7,"clue":"Job benefits","answer":"PERKS","row":4,"col":0,"dir":"across"}],"down":[{"number":1,"clue":"Arrangement","answer":"SETUP","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Property holder","answer":"OWNER","row":0,"col":2,"dir":"down"},{"number":3,"clue":"Makes money","answer":"EARNS","row":0,"col":4,"dir":"down"}]},"answers":{"across_1":"SCOPE","across_4":"TONER","across_7":"PERKS","down_1":"SETUP","down_2":"OWNER","down_3":"EARNS"}},
  {"title":"Breeze","size":5,"gridData":[["G","R","A","I","N"],["R","#","L","#","E"],["O","Z","O","N","E"],["A","#","E","#","D"],["N","E","S","T","S"]],"clues":{"across":[{"number":1,"clue":"Wheat or rice, e.g.","answer":"GRAIN","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Earth's protective layer","answer":"OZONE","row":2,"col":0,"dir":"across"},{"number":7,"clue":"Bird homes","answer":"NESTS","row":4,"col":0,"dir":"across"}],"down":[{"number":1,"clue":"Sound of pain","answer":"GROAN","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Soothing plants","answer":"ALOES","row":0,"col":2,"dir":"down"},{"number":3,"clue":"Requirements","answer":"NEEDS","row":0,"col":4,"dir":"down"}]},"answers":{"across_1":"GRAIN","across_4":"OZONE","across_7":"NESTS","down_1":"GROAN","down_2":"ALOES","down_3":"NEEDS"}},
  {"title":"Ember","size":5,"gridData":[["T","R","A","D","E"],["O","#","B","#","L"],["O","L","I","V","E"],["L","#","D","#","C"],["S","P","E","N","T"]],"clues":{"across":[{"number":1,"clue":"Swap or exchange","answer":"TRADE","row":0,"col":0,"dir":"across"},{"number":4,"clue":"Martini garnish","answer":"OLIVE","row":2,"col":0,"dir":"across"},{"number":7,"clue":"Used up","answer":"SPENT","row":4,"col":0,"dir":"across"}],"down":[{"number":1,"clue":"Hammer and wrench, e.g.","answer":"TOOLS","row":0,"col":0,"dir":"down"},{"number":2,"clue":"Put up with","answer":"ABIDE","row":0,"col":2,"dir":"down"},{"number":3,"clue":"Choose by voting","answer":"ELECT","row":0,"col":4,"dir":"down"}]},"answers":{"across_1":"TRADE","across_4":"OLIVE","across_7":"SPENT","down_1":"TOOLS","down_2":"ABIDE","down_3":"ELECT"}}
];

/* ‚ïê‚ïê‚ïê API PUZZLE GENERATOR ‚ïê‚ïê‚ïê */
async function fetchWords(pattern) {
  const url = `https://api.datamuse.com/words?sp=${encodeURIComponent(pattern)}&md=d&max=30`;
  const res = await fetch(url);
  const data = await res.json();
  return data.filter(w => w.word.length === pattern.length && /^[a-z]+$/.test(w.word) && w.defs && w.defs.length > 0)
    .map(w => ({ word: w.word.toUpperCase(), clue: cleanDef(w.defs[0]) }));
}

function cleanDef(d) {
  const p = d.split('\t');
  let t = p.length > 1 ? p[1] : p[0];
  t = t.charAt(0).toUpperCase() + t.slice(1);
  return t.length > 60 ? t.substring(0, 57) + '...' : t;
}

function pick(a) { return a[Math.floor(Math.random() * a.length)]; }

async function generateAPIPuzzle() {
  const statusEl = document.getElementById('puzzleStatus');
  statusEl.innerHTML = '<span class="loading-spinner"></span>Generating fresh puzzle...';
  try {
    const seeds = 'abcdefghijklmnoprstw';
    const letter = seeds[Math.floor(Math.random() * seeds.length)];
    const pool = await fetchWords(letter + '????');
    if (pool.length < 3) throw new Error('Insufficient words');
    // shuffle
    for (let i = pool.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }

    for (let attempt = 0; attempt < 30; attempt++) {
      const r0c = pool[attempt % pool.length];
      const r0 = r0c.word;
      const [c0p, c2p, c4p] = await Promise.all([
        fetchWords(r0[0].toLowerCase()+'????'),
        fetchWords(r0[2].toLowerCase()+'????'),
        fetchWords(r0[4].toLowerCase()+'????')
      ]);
      if (!c0p.length || !c2p.length || !c4p.length) continue;
      const c0c = pick(c0p), c2c = pick(c2p), c4c = pick(c4p);
      const c0=c0c.word, c2=c2c.word, c4=c4c.word;

      const r2pat = c0[2].toLowerCase()+'?'+c2[2].toLowerCase()+'?'+c4[2].toLowerCase();
      const r2p = await fetchWords(r2pat);
      if (!r2p.length) continue;
      const r2c = pick(r2p), r2 = r2c.word;

      const r4pat = c0[4].toLowerCase()+'?'+c2[4].toLowerCase()+'?'+c4[4].toLowerCase();
      const r4p = await fetchWords(r4pat);
      if (!r4p.length) continue;
      const r4c = pick(r4p), r4 = r4c.word;

      if (new Set([r0,r2,r4,c0,c2,c4]).size !== 6) continue;

      const S = s => s.split('');
      statusEl.textContent = '';
      return {
        source:'api', title:'Fresh Puzzle', size:5,
        gridData: [S(r0), [c0[1],'#',c2[1],'#',c4[1]], S(r2), [c0[3],'#',c2[3],'#',c4[3]], S(r4)],
        clues: {
          across: [
            {number:1,clue:r0c.clue,answer:r0,row:0,col:0,dir:'across'},
            {number:4,clue:r2c.clue,answer:r2,row:2,col:0,dir:'across'},
            {number:7,clue:r4c.clue,answer:r4,row:4,col:0,dir:'across'}
          ],
          down: [
            {number:1,clue:c0c.clue,answer:c0,row:0,col:0,dir:'down'},
            {number:2,clue:c2c.clue,answer:c2,row:0,col:2,dir:'down'},
            {number:3,clue:c4c.clue,answer:c4,row:0,col:4,dir:'down'}
          ]
        },
        answers:{across_1:r0,across_4:r2,across_7:r4,down_1:c0,down_2:c2,down_3:c4}
      };
    }
    throw new Error('No valid combo found');
  } catch(e) {
    console.log('API fallback:', e.message);
    statusEl.textContent = '';
    return getEmbeddedPuzzle();
  }
}

function getEmbeddedPuzzle() {
  const p = EMBEDDED_PUZZLES[Math.floor(Math.random()*EMBEDDED_PUZZLES.length)];
  return {source:'embedded', ...p};
}

/* ‚ïê‚ïê‚ïê CUSTOM PUZZLES ‚ïê‚ïê‚ïê */
async function fetchCustomPuzzles() {
  try {
    const snap = await db.ref('custom_puzzles').orderByChild('created').limitToLast(20).once('value');
    const puzzles = [];
    snap.forEach(c => puzzles.push({id:c.key,...c.val()}));
    state.customPuzzles = puzzles.reverse();
    renderCustomPuzzleSelect();
  } catch(e) { console.log('No custom puzzles:', e.message); }
}
function renderCustomPuzzleSelect() {
  const sel = document.getElementById('customPuzzleSelect');
  sel.innerHTML = state.customPuzzles.length === 0
    ? '<option value="">No family puzzles yet ‚Äî build one!</option>'
    : '<option value="">Choose a puzzle...</option>';
  for (const p of state.customPuzzles) {
    const o = document.createElement('option'); o.value=p.id; o.textContent=p.title||'Untitled'; sel.appendChild(o);
  }
}

/* ‚ïê‚ïê‚ïê UI HELPERS ‚ïê‚ïê‚ïê */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function setMode(mode, el) {
  state.mode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
  if (el) el.classList.add('selected');
  const roomArea = document.getElementById('roomArea');
  const btnPlay = document.getElementById('btnPlay');
  if (mode === 'solo') {
    roomArea.style.display='none';
    btnPlay.style.display='';
  } else {
    roomArea.style.display='';
    btnPlay.style.display='none';
  }
}
function setPuzzleType(type, el) {
  state.puzzleType = type;
  document.querySelectorAll('.puzzle-btn').forEach(b => b.classList.remove('selected'));
  if (el) el.classList.add('selected');
  document.getElementById('customPuzzleArea').style.display = type==='custom'?'':'none';
  if (type==='custom') fetchCustomPuzzles();
}
function setDirection(dir) {
  state.direction = dir;
  document.getElementById('btnAcross').classList.toggle('active', dir==='across');
  document.getElementById('btnDown').classList.toggle('active', dir==='down');
  if (state.selectedCell) { highlightWord(); updateActiveClue(); }
}
function toggleClueDrawer() { document.getElementById('clueDrawer').classList.toggle('open'); }

/* ‚ïê‚ïê‚ïê GAME FLOW ‚ïê‚ïê‚ïê */
async function startGame() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { document.getElementById('inputName').focus(); return; }
  state.playerName=name; state.playerId='solo'; state.mode='solo';
  let puzzle;
  if (state.puzzleType==='custom') {
    const id = document.getElementById('customPuzzleSelect').value;
    const found = state.customPuzzles.find(p=>p.id===id);
    puzzle = found ? {source:'custom',...found} : await generateAPIPuzzle();
  } else { puzzle = await generateAPIPuzzle(); }
  state.puzzle = puzzle;
  initGame();
}
async function createRoom() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { document.getElementById('inputName').focus(); return; }
  state.playerName=name; state.playerId='p1';
  state.roomCode = genRoomCode();
  let puzzle;
  if (state.puzzleType==='custom') {
    const id = document.getElementById('customPuzzleSelect').value;
    const found = state.customPuzzles.find(p=>p.id===id);
    puzzle = found ? {source:'custom',...found} : await generateAPIPuzzle();
  } else { puzzle = await generateAPIPuzzle(); }
  state.puzzle = puzzle;
  const ref = db.ref('rooms/'+state.roomCode);
  state.roomRef = ref;
  ref.set({
    p1:{name:state.playerName,connected:true}, p2:{name:'',connected:false},
    mode:state.mode, puzzle, cells:{}, scores:{p1:0,p2:0}, cursors:{},
    status:'waiting', timerStart:null,
    created:firebase.database.ServerValue.TIMESTAMP
  });
  document.getElementById('waitingRoomCode').textContent = state.roomCode;
  const link = `${location.origin}${location.pathname}?room=${state.roomCode}`;
  document.getElementById('shareUrl').textContent = link;
  document.getElementById('slotP1Name').textContent = state.playerName;
  showScreen('screenWaiting');
  ref.child('p2').on('value', snap => {
    const p2 = snap.val();
    if (p2 && p2.connected) {
      document.getElementById('slotP2').classList.add('connected');
      document.getElementById('slotP2Name').textContent = p2.name;
      ref.update({status:'playing', timerStart:firebase.database.ServerValue.TIMESTAMP});
      initGame();
    }
  });
}
function joinRoom() {
  const name = document.getElementById('inputName').value.trim();
  const code = document.getElementById('inputRoom').value.trim().toUpperCase();
  if (!name) { document.getElementById('inputName').focus(); return; }
  if (!code||code.length<4) { document.getElementById('inputRoom').focus(); return; }
  state.playerName=name; state.roomCode=code; state.playerId='p2';
  const ref = db.ref('rooms/'+code);
  state.roomRef = ref;
  ref.once('value').then(snap => {
    if (!snap.exists()) { alert('Room not found!'); return; }
    const room = snap.val();
    state.mode = room.mode; state.puzzle = room.puzzle;
    ref.child('p2').set({name:state.playerName,connected:true});
    ref.child('status').on('value', s => { if (s.val()==='playing') initGame(); });
    document.getElementById('waitingRoomCode').textContent = code;
    document.getElementById('slotP1Name').textContent = room.p1.name;
    document.getElementById('slotP2Name').textContent = state.playerName;
    document.getElementById('slotP2').classList.add('connected');
    showScreen('screenWaiting');
  });
}
function genRoomCode() {
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ'; let s='';
  for (let i=0;i<5;i++) s+=c[Math.floor(Math.random()*c.length)];
  return s;
}
function copyShareUrl() {
  const el = document.getElementById('shareUrl');
  const t = el.textContent;
  navigator.clipboard?.writeText(t);
  el.textContent = '‚úì Copied!';
  setTimeout(()=>{ el.textContent=t; }, 2000);
}

/* ‚ïê‚ïê‚ïê INIT GAME ‚ïê‚ïê‚ïê */
function initGame() {
  state.gameComplete=false; state.scores={p1:0,p2:0};
  state.selectedCell=null; state.direction='across';
  const puzzle = state.puzzle;
  const gd = puzzle.gridData;
  const rows = gd.length, cols = gd[0].length;
  state.grid = [];
  for (let r=0;r<rows;r++) {
    state.grid[r]=[];
    for (let c=0;c<cols;c++) {
      const isBlack = gd[r][c]==='#';
      state.grid[r][c] = {
        letter: isBlack?'#':gd[r][c], isBlack, number:null,
        filled:{shared:'',p1:'',p2:''}, acrossClue:null, downClue:null
      };
    }
  }
  state.clues = puzzle.clues;
  state.answers = puzzle.answers||{};
  for (const dir of ['across','down']) {
    for (const clue of state.clues[dir]) {
      if (state.grid[clue.row]?.[clue.col]) state.grid[clue.row][clue.col].number = clue.number;
      for (let i=0;i<clue.answer.length;i++) {
        const r = clue.dir==='across'?clue.row:clue.row+i;
        const c = clue.dir==='across'?clue.col+i:clue.col;
        if (state.grid[r]?.[c]) {
          if (dir==='across') state.grid[r][c].acrossClue=clue;
          else state.grid[r][c].downClue=clue;
        }
      }
    }
  }
  document.getElementById('hudTitle').textContent = puzzle.title||'Puzzle';
  buildGrid(rows,cols);
  buildCluePanel();
  state.timerStart = Date.now();
  clearInterval(state.timerInterval);
  state.timerInterval = setInterval(updateTimer, 1000);
  document.getElementById('hudScore').textContent = '0/'+( state.clues.across.length+state.clues.down.length);
  showScreen('screenGame');
  // Must recalculate after screen is visible so clientWidth/Height are non-zero
  requestAnimationFrame(()=>{ calcCellSize(rows,cols); });
  if (state.mode!=='solo' && state.roomRef) listenRoom();
  window.addEventListener('resize', ()=>calcCellSize(rows,cols));
}

function calcCellSize(rows, cols) {
  const w = document.getElementById('gridWrapper');
  if (!w) return;
  const aW = w.clientWidth-16, aH = w.clientHeight-16;
  const cs = Math.min(Math.floor(aW/cols), Math.floor(aH/rows), 72);
  document.getElementById('crosswordGrid').style.setProperty('--cell-size', cs+'px');
}

function buildGrid(rows, cols) {
  const g = document.getElementById('crosswordGrid');
  g.innerHTML='';
  g.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;
  g.style.gridTemplateRows = `repeat(${rows}, var(--cell-size))`;
  for (let r=0;r<rows;r++) {
    for (let c=0;c<cols;c++) {
      const cell = document.createElement('div');
      cell.className='grid-cell'; cell.dataset.row=r; cell.dataset.col=c;
      const d = state.grid[r][c];
      if (d.isBlack) { cell.classList.add('black'); }
      else {
        if (d.number) { const n=document.createElement('span'); n.className='cell-number'; n.textContent=d.number; cell.appendChild(n); }
        const l = document.createElement('span'); l.className='cell-letter'; l.id=`letter_${r}_${c}`; cell.appendChild(l);
        cell.addEventListener('click', ()=>handleCellClick(r,c));
      }
      g.appendChild(cell);
    }
  }
}

function buildCluePanel() {
  for (const dir of ['across','down']) {
    const ct = document.getElementById(dir==='across'?'clueListAcross':'clueListDown');
    ct.innerHTML='';
    for (const clue of state.clues[dir]) {
      const item = document.createElement('div');
      item.className='clue-item'; item.id=`clue_${dir}_${clue.number}`;
      item.innerHTML = `<span class="clue-item-num">${clue.number}</span><span class="clue-item-text">${clue.clue}</span>`;
      item.addEventListener('click', ()=>{
        state.direction=dir;
        document.getElementById('btnAcross').classList.toggle('active',dir==='across');
        document.getElementById('btnDown').classList.toggle('active',dir==='down');
        handleCellClick(clue.row, clue.col);
        document.getElementById('clueDrawer').classList.remove('open');
      });
      ct.appendChild(item);
    }
  }
}

/* ‚ïê‚ïê‚ïê CELL INTERACTION ‚ïê‚ïê‚ïê */
function handleCellClick(r,c) {
  if (state.grid[r][c].isBlack) return;
  if (state.selectedCell && state.selectedCell.row===r && state.selectedCell.col===c) {
    state.direction = state.direction==='across'?'down':'across';
    document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
    document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
  }
  state.selectedCell={row:r,col:c};
  highlightWord(); updateActiveClue();
  if (state.roomRef) state.roomRef.child(`cursors/${state.playerId}`).set({row:r,col:c});
}

function highlightWord() {
  document.querySelectorAll('.grid-cell').forEach(e => e.classList.remove('selected','word-highlight'));
  if (!state.selectedCell) return;
  const {row,col}=state.selectedCell;
  const cd = state.grid[row][col];
  let clue = state.direction==='across'?cd.acrossClue:cd.downClue;
  if (!clue) {
    const alt = state.direction==='across'?cd.downClue:cd.acrossClue;
    if (alt) {
      state.direction = state.direction==='across'?'down':'across';
      document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
      document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
      clue=alt;
    }
  }
  if (clue) {
    for (let i=0;i<clue.answer.length;i++) {
      const cr=clue.dir==='across'?clue.row:clue.row+i;
      const cc=clue.dir==='across'?clue.col+i:clue.col;
      const el=getCellEl(cr,cc); if(el) el.classList.add('word-highlight');
    }
  }
  const ae=getCellEl(row,col); if(ae) ae.classList.add('selected');
}

function updateActiveClue() {
  if (!state.selectedCell) return;
  const {row,col}=state.selectedCell;
  const cd=state.grid[row][col];
  const clue = state.direction==='across'?cd.acrossClue:cd.downClue;
  if (clue) {
    document.getElementById('activeClueNum').textContent = `${clue.number}${clue.dir==='across'?'A':'D'}`;
    document.getElementById('activeClueText').textContent = clue.clue;
  }
}

function getCellEl(r,c) { return document.querySelector(`.grid-cell[data-row="${r}"][data-col="${c}"]`); }

/* ‚ïê‚ïê‚ïê KEYBOARD ‚ïê‚ïê‚ïê */

document.addEventListener('keydown', e => {
  if (!state.selectedCell) return;
  if (document.activeElement?.tagName==='INPUT'||document.activeElement?.tagName==='SELECT') return;
  if (e.key==='ArrowUp'){e.preventDefault();moveSelection(0,-1);return;}
  if (e.key==='ArrowDown'){e.preventDefault();moveSelection(0,1);return;}
  if (e.key==='ArrowLeft'){e.preventDefault();moveSelection(-1,0);return;}
  if (e.key==='ArrowRight'){e.preventDefault();moveSelection(1,0);return;}
  if (e.key==='Tab'||e.key===' '){
    e.preventDefault();
    state.direction=state.direction==='across'?'down':'across';
    document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
    document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
    highlightWord();updateActiveClue();return;
  }
  if (e.key==='Backspace'||e.key==='Delete'){e.preventDefault();handleBackspace();return;}
  const l=e.key.toUpperCase();
  if (/^[A-Z]$/.test(l)){e.preventDefault();typeLetter(l);}
});

function typeLetter(l) {
  if (!state.selectedCell||state.gameComplete) return;
  setLetter(state.selectedCell.row,state.selectedCell.col,l);
  advanceCursor();
}

function handleBackspace() {
  if (!state.selectedCell||state.gameComplete) return;
  const {row,col}=state.selectedCell;
  if (getDisplayed(row,col)) { setLetter(row,col,''); }
  else { retreatCursor(); if (state.selectedCell) setLetter(state.selectedCell.row,state.selectedCell.col,''); }
}

function getDisplayed(r,c) {
  return state.mode==='competitive'?(state.grid[r][c].filled[state.playerId]||''):(state.grid[r][c].filled.shared||'');
}

function setLetter(row,col,letter) {
  if (state.mode==='solo') {
    state.grid[row][col].filled.shared=letter;
    updateCellDisplay(row,col); checkCompletion();
  } else if (state.roomRef) {
    const k=`${row}_${col}`;
    if (state.mode==='collaborative') {
      state.roomRef.child(`cells/${k}`).set({letter,owner:state.playerId});
      state.grid[row][col].filled.shared=letter;
    } else {
      state.roomRef.child(`cells/${k}/${state.playerId}`).set(letter);
      state.grid[row][col].filled[state.playerId]=letter;
    }
    updateCellDisplay(row,col); checkCompletion();
  }
}

function updateCellDisplay(r,c) {
  const el=document.getElementById(`letter_${r}_${c}`); if(!el) return;
  el.textContent = state.mode==='competitive'?(state.grid[r][c].filled[state.playerId]||''):(state.grid[r][c].filled.shared||'');
}

function advanceCursor() {
  if (!state.selectedCell) return;
  let {row,col}=state.selectedCell;
  const R=state.grid.length, C=state.grid[0].length;
  if (state.direction==='across') { col++; while(col<C&&state.grid[row][col].isBlack) col++; if(col>=C) return; }
  else { row++; while(row<R&&state.grid[row][col].isBlack) row++; if(row>=R) return; }
  state.selectedCell={row,col}; highlightWord(); updateActiveClue();
  if (state.roomRef) state.roomRef.child(`cursors/${state.playerId}`).set({row,col});
}

function retreatCursor() {
  if (!state.selectedCell) return;
  let {row,col}=state.selectedCell;
  if (state.direction==='across') { col--; while(col>=0&&state.grid[row][col].isBlack) col--; if(col<0) return; }
  else { row--; while(row>=0&&state.grid[row][col].isBlack) row--; if(row<0) return; }
  state.selectedCell={row,col}; highlightWord(); updateActiveClue();
}

function moveSelection(dx,dy) {
  if (!state.selectedCell) return;
  let {row,col}=state.selectedCell;
  const R=state.grid.length, C=state.grid[0].length;
  let nr=row+dy, nc=col+dx;
  while(nr>=0&&nr<R&&nc>=0&&nc<C&&state.grid[nr][nc].isBlack){nr+=dy;nc+=dx;}
  if(nr>=0&&nr<R&&nc>=0&&nc<C&&!state.grid[nr][nc].isBlack){
    state.selectedCell={row:nr,col:nc};
    if(dx!==0) state.direction='across';
    if(dy!==0) state.direction='down';
    document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
    document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
    highlightWord(); updateActiveClue();
  }
}

/* ‚ïê‚ïê‚ïê FIREBASE LISTENERS ‚ïê‚ïê‚ïê */
function listenRoom() {
  if (!state.roomRef) return;
  state.roomRef.child('cells').on('value', snap => {
    const cells=snap.val(); if(!cells) return;
    for (const k of Object.keys(cells)) {
      const [r,c]=k.split('_').map(Number);
      if (!state.grid[r]?.[c]) continue;
      if (state.mode==='collaborative') { state.grid[r][c].filled.shared=cells[k].letter||''; }
      else { const d=cells[k]; if(d.p1!==undefined) state.grid[r][c].filled.p1=d.p1; if(d.p2!==undefined) state.grid[r][c].filled.p2=d.p2; }
      updateCellDisplay(r,c);
    }
    checkCompletion();
  });
  const peer = state.playerId==='p1'?'p2':'p1';
  state.roomRef.child(`cursors/${peer}`).on('value', snap => {
    document.querySelectorAll('.peer-cursor').forEach(e=>e.classList.remove('peer-cursor'));
    const cur=snap.val(); if(cur){const el=getCellEl(cur.row,cur.col);if(el) el.classList.add('peer-cursor');}
  });
  state.roomRef.child('scores').on('value', snap => { const s=snap.val(); if(s) state.scores=s; });
}

/* ‚ïê‚ïê‚ïê COMPLETION ‚ïê‚ïê‚ïê */
function checkCompletion() {
  if (state.gameComplete) return;
  let done=0, total=0;
  for (const dir of ['across','down']) {
    for (const clue of state.clues[dir]) {
      total++;
      let word='';
      for (let i=0;i<clue.answer.length;i++) {
        const r=clue.dir==='across'?clue.row:clue.row+i;
        const c=clue.dir==='across'?clue.col+i:clue.col;
        word += state.mode==='competitive'?(state.grid[r][c].filled[state.playerId]||''):(state.grid[r][c].filled.shared||'');
      }
      const el=document.getElementById(`clue_${clue.dir}_${clue.number}`);
      if (word.toUpperCase()===clue.answer.toUpperCase()) { done++; if(el) el.classList.add('completed'); }
      else { if(el) el.classList.remove('completed'); }
    }
  }
  document.getElementById('hudScore').textContent = `${done}/${total}`;
  if (done===total) { state.gameComplete=true; clearInterval(state.timerInterval); showWinScreen(); }
}

/* ‚ïê‚ïê‚ïê WIN ‚ïê‚ïê‚ïê */
function showWinScreen() {
  const elapsed=Math.floor((Date.now()-state.timerStart)/1000);
  const ts=`${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
  const tw = state.clues.across.length+state.clues.down.length;
  if (state.mode==='solo') {
    document.getElementById('winTitle').textContent=`Nice work, ${state.playerName}!`;
    document.getElementById('winSubtitle').textContent=state.puzzle.title||'';
    document.getElementById('winStats').innerHTML=`<div style="text-align:center"><div class="win-stat-val">${ts}</div><div class="win-stat-label">Time</div></div><div style="text-align:center"><div class="win-stat-val">${tw}</div><div class="win-stat-label">Words</div></div>`;
    document.getElementById('winScores').style.display='none';
  } else if (state.mode==='collaborative') {
    document.getElementById('winTitle').textContent='You solved it together! ü§ùüèæ';
    document.getElementById('winSubtitle').textContent=state.puzzle.title||'';
    document.getElementById('winStats').innerHTML=`<div style="text-align:center"><div class="win-stat-val">${ts}</div><div class="win-stat-label">Time</div></div><div style="text-align:center"><div class="win-stat-val">${tw}</div><div class="win-stat-label">Words</div></div>`;
  } else {
    const p1=state.scores.p1||0, p2=state.scores.p2||0;
    const w=p1>p2?'Player 1':p2>p1?'Player 2':'Tie';
    document.getElementById('winTitle').textContent=w==='Tie'?"It's a tie!":`${w} wins!`;
    document.getElementById('winSubtitle').textContent=ts;
    document.getElementById('winScores').style.display='flex';
    document.getElementById('winScores').innerHTML=`<div style="text-align:center"><div class="win-stat-val">${p1}</div><div class="win-stat-label">P1</div></div><div style="text-align:center"><div class="win-stat-val">${p2}</div><div class="win-stat-label">P2</div></div>`;
  }
  showScreen('screenWin');
}

/* ‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê */
function updateTimer() {
  if (!state.timerStart) return;
  const e=Math.floor((Date.now()-state.timerStart)/1000);
  document.getElementById('hudTimer').textContent=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,'0')}`;
}

/* ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê */
function leaveRoom() {
  clearInterval(state.timerInterval);
  if (state.roomRef){state.roomRef.off();state.roomRef=null;}
  document.getElementById('clueDrawer').classList.remove('open');
  state.selectedCell=null; state.gameComplete=false; state.puzzle=null;
  showScreen('screenLobby');
}
function backToLobby() { leaveRoom(); }

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
(function(){
  const p=new URLSearchParams(location.search);
  const room=p.get('room');
  if (room) {
    document.getElementById('inputRoom').value=room.toUpperCase();
    setMode('collaborative', document.querySelectorAll('.mode-btn')[1]);
    // Auto-focus the join input so it's obvious
    setTimeout(()=>document.getElementById('inputRoom').focus(), 300);
  }
})();

document.addEventListener('touchstart', e => {
  if (e.target.closest('.grid-cell')) e.preventDefault();
}, {passive:false});

// OSK: use touchend + click for maximum compatibility
function handleOSKPress(e) {
  const btn = e.target.closest('.osk-key');
  if (!btn) return;
  e.preventDefault();
  const key = btn.dataset.key;
  if (key==='BACKSPACE') { handleBackspace(); return; }
  if (key==='TOGGLE') {
    state.direction=state.direction==='across'?'down':'across';
    document.getElementById('btnAcross').classList.toggle('active',state.direction==='across');
    document.getElementById('btnDown').classList.toggle('active',state.direction==='down');
    if (state.selectedCell) { highlightWord(); updateActiveClue(); }
    return;
  }
  if (/^[A-Z]$/.test(key)) typeLetter(key);
}
document.getElementById('osk').addEventListener('touchend', handleOSKPress);
document.getElementById('osk').addEventListener('click', handleOSKPress);
</script>
</body>
</html>
